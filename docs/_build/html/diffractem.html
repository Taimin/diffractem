
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>diffractem package &#8212; diffractem  documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="diffractem-package">
<h1>diffractem package<a class="headerlink" href="#diffractem-package" title="Permalink to this headline">¶</a></h1>
<div class="section" id="submodules">
<h2>Submodules<a class="headerlink" href="#submodules" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="module-diffractem.adxv">
<span id="diffractem-adxv-module"></span><h2>diffractem.adxv module<a class="headerlink" href="#module-diffractem.adxv" title="Permalink to this headline">¶</a></h2>
<p>Adxv remote control.</p>
<p>Inspired by:
<a class="reference external" href="https://github.com/erikssod/adxv_class">https://github.com/erikssod/adxv_class</a> by Daniel Eriksson (MIT license)
<a class="reference external" href="https://github.com/keitaroyam/yamtbx">https://github.com/keitaroyam/yamtbx</a> by Keitaro Yamashita (BSD license)</p>
<dl class="py class">
<dt id="diffractem.adxv.Adxv">
<em class="property">class </em><code class="sig-prename descclassname">diffractem.adxv.</code><code class="sig-name descname">Adxv</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">adxv_bin</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">hdf5_path</span><span class="o">=</span><span class="default_value">'/entry/data/raw_counts'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py method">
<dt id="diffractem.adxv.Adxv.contrast_max">
<code class="sig-name descname">contrast_max</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.contrast_max" title="Permalink to this definition">¶</a></dt>
<dd><p>contrast_max - sets the max contrast value</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.contrast_min">
<code class="sig-name descname">contrast_min</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.contrast_min" title="Permalink to this definition">¶</a></dt>
<dd><p>contrast_min - sets the min contrast value</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.define_spot">
<code class="sig-name descname">define_spot</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">color</span></em>, <em class="sig-param"><span class="n">radius</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">box</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">group</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.define_spot" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.exit">
<code class="sig-name descname">exit</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.exit" title="Permalink to this definition">¶</a></dt>
<dd><p>Exit Adxv</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.increment_files">
<code class="sig-name descname">increment_files</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.increment_files" title="Permalink to this definition">¶</a></dt>
<dd><p>increment_files - unchecks the +Slabs checkbox in the Load Window</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.increment_slabs">
<code class="sig-name descname">increment_slabs</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.increment_slabs" title="Permalink to this definition">¶</a></dt>
<dd><p>increment_slabs - checks the +Slabs checkbox in the Load Window</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.is_alive">
<code class="sig-name descname">is_alive</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.is_alive" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.load_image">
<code class="sig-name descname">load_image</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">image_file</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.load_image" title="Permalink to this definition">¶</a></dt>
<dd><p>Load an image file</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.load_spots">
<code class="sig-name descname">load_spots</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">spots</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.load_spots" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.raise_image">
<code class="sig-name descname">raise_image</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.raise_image" title="Permalink to this definition">¶</a></dt>
<dd><p>Raises image window; see raise_window for
additional options but this seems like the
most common one.</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.raise_window">
<code class="sig-name descname">raise_window</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">window</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.raise_window" title="Permalink to this definition">¶</a></dt>
<dd><p>Raises a Window. &lt;window&gt; must be one of
‘Control’, ‘Image’, ‘Magnify’, ‘Line’, or
‘Load’.</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.save_image">
<code class="sig-name descname">save_image</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">path_name_format</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.save_image" title="Permalink to this definition">¶</a></dt>
<dd><p>Save an image file (jpeg or tiff)</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.send">
<code class="sig-name descname">send</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">payload</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.send" title="Permalink to this definition">¶</a></dt>
<dd><p>Takes command, encodes it, and sends it down the socket.</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.set_slab">
<code class="sig-name descname">set_slab</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.set_slab" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as slab, but don’t load the image</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.set_slabs">
<code class="sig-name descname">set_slabs</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.set_slabs" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as slabs, but don’t load the image</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.slab">
<code class="sig-name descname">slab</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.slab" title="Permalink to this definition">¶</a></dt>
<dd><p>Display slab N</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.slabs">
<code class="sig-name descname">slabs</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.slabs" title="Permalink to this definition">¶</a></dt>
<dd><p>Slab thickness to display</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.start">
<code class="sig-name descname">start</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">cwd</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.start" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.adxv.Adxv.stride">
<code class="sig-name descname">stride</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">N</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.adxv.Adxv.stride" title="Permalink to this definition">¶</a></dt>
<dd><p>stride - sets Stride in the Load Window</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-diffractem.compute">
<span id="diffractem-compute-module"></span><h2>diffractem.compute module<a class="headerlink" href="#module-diffractem.compute" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.compute.map_reduction_func">
<code class="sig-prename descclassname">diffractem.compute.</code><code class="sig-name descname">map_reduction_func</code><span class="sig-paren">(</span><em class="sig-param">imgs</em>, <em class="sig-param">fun</em>, <em class="sig-param">*args</em>, <em class="sig-param">output_len=1</em>, <em class="sig-param">dtype=&lt;class 'float'&gt;</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.compute.map_reduction_func" title="Permalink to this definition">¶</a></dt>
<dd><p>Use dask array map blocks for functions that return a numpy vector of values (e.g. fit functions or 1D profiles)
:param imgs: image stack as dask array, stacked along dimension 0
:param fun: function to apply, needs to be able to process image stacks
:param args: positional arguments to be supplied to the function. Note that these have to have three dimensions
:param output_len: length of output numpy vector
:param dtype: data type of output numpy vector
:param kwargs: keyword arguments to be supplied to the function
:return:</p>
</dd></dl>

</div>
<div class="section" id="module-diffractem.dataset">
<span id="diffractem-dataset-module"></span><h2>diffractem.dataset module<a class="headerlink" href="#module-diffractem.dataset" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="diffractem.dataset.Dataset">
<em class="property">class </em><code class="sig-prename descclassname">diffractem.dataset.</code><code class="sig-name descname">Dataset</code><a class="headerlink" href="#diffractem.dataset.Dataset" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py method">
<dt id="diffractem.dataset.Dataset.Stacks">
<code class="sig-name descname">Stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.Stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Context manager to handle the opening and closing of stacks.
returns the opened data stacks, which are automatically closed
once the context is left. Arguments are passed to open_stacks Example:</p>
<blockquote>
<div><dl class="simple">
<dt>with ds.Stacks(readonly=True, chunking=’dataset’) as stk:</dt><dd><p>center = stk.beam_center.compute()</p>
</dd>
</dl>
<p>print(‘Have’, center.shape[0], ‘centers.’)</p>
</div></blockquote>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.add_stack">
<code class="sig-name descname">add_stack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">label</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">stack</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>dask.array.core.Array<span class="p">, </span>numpy.ndarray<span class="p">, </span>h5py._hl.dataset.Dataset<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">overwrite</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">diff_stack</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">persist</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">rechunk</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.add_stack" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds a data stack to the data set
:param label: label of the new stack
:param stack: new stack, can be anything array-like
:param overwrite: allows overwriting an existing stack
:param diff_stack: marks this stack as the main diffraction data
:param persist: persists the dask array to memory, if it is generated</p>
<blockquote>
<div><p>from a numpy array</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>rechunk</strong> – if True, a dask array with chunks along the stack direction that don’t match the datasets
other stacks chunks will be rechunked. Otherwise, a warning is shown.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.aggregate">
<code class="sig-name descname">aggregate</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">by</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>list<span class="p">, </span>tuple<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'sample', 'region', 'run', 'crystal_id'</span></em>, <em class="sig-param"><span class="n">how</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>dict<span class="p">, </span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'mean'</span></em>, <em class="sig-param"><span class="n">file_suffix</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'_agg.h5'</span></em>, <em class="sig-param"><span class="n">file_prefix</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">''</span></em>, <em class="sig-param"><span class="n">new_folder</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">query</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">force_commensurate</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">exclude_stacks</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>list<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference internal" href="#diffractem.dataset.Dataset" title="diffractem.dataset.Dataset">diffractem.dataset.Dataset</a><a class="headerlink" href="#diffractem.dataset.Dataset.aggregate" title="Permalink to this definition">¶</a></dt>
<dd><p>Aggregate sub-sets of stacks using different aggregation functions. Typical application: sum sub-stacks of
dose fractionation movies, or shots with different tilt angles (quasi-precession)
:param by: shot table columns to group by for aggregation. Default: (‘run’, ‘region’, ‘crystal_id’, ‘sample’)
:param how: aggregation types. ‘sum’, ‘mean’, and ‘cumsum’ are supported. Can be a single operation for all</p>
<blockquote>
<div><p>stacks, or a dict, specifying different ones for each, in which case all non-explicitly specified stacks
will default to ‘mean’, e.g. how={‘raw_counts’: ‘sum’}.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>file_suffix</strong> – as in Dataset.change_filenames</p></li>
<li><p><strong>file_prefix</strong> – as in Dataset.change_filenames</p></li>
<li><p><strong>new_folder</strong> – as in Dataset.change_filenames</p></li>
<li><p><strong>query</strong> – apply a query (see select or get_selection)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>a new data set with aggregation applied</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.change_filenames">
<code class="sig-name descname">change_filenames</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file_suffix</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'.h5'</span></em>, <em class="sig-param"><span class="n">file_prefix</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">''</span></em>, <em class="sig-param"><span class="n">new_folder</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">fn_map</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>pandas.core.frame.DataFrame<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">keep_raw</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.change_filenames" title="Permalink to this definition">¶</a></dt>
<dd><p>Change file names in all lists using some handy modifications. The old file names are copied to a “file_raw”
column, if not already present (can be overriden with keep_raw).
:param file_suffix: add suffix to file, INCLUDING file extension, e.g. ‘_modified.h5’
:param file_prefix: add prefix to actual filenames (not folder/full path!), e.g. ‘<a href="#id15"><span class="problematic" id="id16">aggregated_</span></a>
:param new_folder: if not None, changes folder name to this path
:param fn_map: if not None, gives an explicit table (pd.DataFrame) with columns ‘file’ and ‘file_new’</p>
<blockquote>
<div><p>that manually maps old to new filenames. All other parameters are ignored, if provided</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>keep_raw</strong> – if True (default), does not change the file_raw column in the shot list,
unless there is none yet (in which case the old file names are _always_ copied to keep_raw)</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>DataFrame with a map from old to new file names (for reference)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.close_stacks">
<code class="sig-name descname">close_stacks</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.close_stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Close the stacks by closing the HDF5 data file handles.
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.compute_and_save">
<code class="sig-name descname">compute_and_save</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">diff_stack_label</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">list_file</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">client</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>distributed.client.Client<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exclude_stacks</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>List<span class="p">[</span>str<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">overwrite</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">persist_diff</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">persist_all</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">compression</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>int<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">32004</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.compute_and_save" title="Permalink to this definition">¶</a></dt>
<dd><p>Compound method to fully compute a dataset and write it to disk. It is designed for completely writing HDF5
files from scratch, not to append to existing ones. Internally calls init_files, store_tables, store_stacks,
store_stack_fast, and write_list.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{Optional</strong><strong>[</strong><strong>str</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>list_file</em>) – {None})</p></li>
<li><p><strong>{Optional</strong><strong>[</strong><strong>str</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> – {None})</p></li>
<li><p><strong>{Optional</strong><strong>[</strong><strong>Client</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>client</em>) – {None})</p></li>
<li><p><strong>{Optional</strong><strong>[</strong><strong>List</strong><strong>[</strong><strong>str</strong><strong>]</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>exclude_stacks</em>) – {None})</p></li>
<li><p><strong>{bool} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>persist_all</em>) – {False})</p></li>
<li><p><strong>{bool} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> – {True})</p></li>
<li><p><strong>{bool} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> – {False})</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>str</strong><strong>, </strong><strong>int</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>compression</em>) – {32004})</p></li>
</ul>
</dd>
<dt class="field-even">Raises</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>ValueError</strong> – [description]</p></li>
<li><p><strong>ValueError</strong> – [description]</p></li>
<li><p><strong>ValueError</strong> – [description]</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.delete_stack">
<code class="sig-name descname">delete_stack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">label</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">from_files</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.delete_stack" title="Permalink to this definition">¶</a></dt>
<dd><p>Delete a data stack
:param label: stack label
:param from_files: if True, the stack is also deleted in the HDF5 files. Default False.
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.diff_stack_label">
<em class="property">property </em><code class="sig-name descname">diff_stack_label</code><a class="headerlink" href="#diffractem.dataset.Dataset.diff_stack_label" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.features">
<em class="property">property </em><code class="sig-name descname">features</code><a class="headerlink" href="#diffractem.dataset.Dataset.features" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.file_handles">
<em class="property">property </em><code class="sig-name descname">file_handles</code><a class="headerlink" href="#diffractem.dataset.Dataset.file_handles" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.files">
<em class="property">property </em><code class="sig-name descname">files</code><a class="headerlink" href="#diffractem.dataset.Dataset.files" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.from_files">
<em class="property">classmethod </em><code class="sig-name descname">from_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">files</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>list<span class="p">, </span>str<span class="p">, </span>tuple<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">open_stacks</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">chunking</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>int<span class="p">, </span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">100</span></em>, <em class="sig-param"><span class="n">persist_meta</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">init_stacks</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">load_tables</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">diff_stack_label</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'raw_counts'</span></em>, <em class="sig-param"><span class="n">validate_files</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.from_files" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Creates a data set from:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>a .lst file name, which contains a simple list of H5 files (on separate lines). If the .lst file has CrystFEL-style</dt><dd><p>event indicators in it, it will be loaded, and the events present in the list will be selected, the others not.</p>
</dd>
</dl>
</li>
<li><p>a glob pattern (like: ‘data/<a href="#id1"><span class="problematic" id="id2">*</span></a>.h5’)</p></li>
<li><p>a python iterable of files.</p></li>
<li><p>a simple HDF5 file path</p></li>
</ul>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>files</strong> – see above</p></li>
<li><p><strong>init_stacks</strong> – initialize stacks, that is, briefly open the data stacks, check their lengths, and close
them again. Does not hurt usually.</p></li>
<li><p><strong>load_tables</strong> – load the additional tables stored in the files (features, peaks, predictions)</p></li>
<li><p><strong>diff_stack_label</strong> – name of stack to be used for generating the shot table, if it’s not stored in the files</p></li>
<li><p><strong>**kwargs</strong> – <p>Dataset attributes to be set right away</p>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>dataset object</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.from_list">
<em class="property">classmethod </em><code class="sig-name descname">from_list</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">files</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>list<span class="p">, </span>str<span class="p">, </span>tuple<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">open_stacks</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">chunking</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>int<span class="p">, </span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">100</span></em>, <em class="sig-param"><span class="n">persist_meta</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">init_stacks</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">load_tables</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">diff_stack_label</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'raw_counts'</span></em>, <em class="sig-param"><span class="n">validate_files</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.from_list" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Creates a data set from:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>a .lst file name, which contains a simple list of H5 files (on separate lines). If the .lst file has CrystFEL-style</dt><dd><p>event indicators in it, it will be loaded, and the events present in the list will be selected, the others not.</p>
</dd>
</dl>
</li>
<li><p>a glob pattern (like: ‘data/<a href="#id5"><span class="problematic" id="id6">*</span></a>.h5’)</p></li>
<li><p>a python iterable of files.</p></li>
<li><p>a simple HDF5 file path</p></li>
</ul>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>files</strong> – see above</p></li>
<li><p><strong>init_stacks</strong> – initialize stacks, that is, briefly open the data stacks, check their lengths, and close
them again. Does not hurt usually.</p></li>
<li><p><strong>load_tables</strong> – load the additional tables stored in the files (features, peaks, predictions)</p></li>
<li><p><strong>diff_stack_label</strong> – name of stack to be used for generating the shot table, if it’s not stored in the files</p></li>
<li><p><strong>**kwargs</strong> – <p>Dataset attributes to be set right away</p>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>dataset object</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.generate_virtual_file">
<code class="sig-name descname">generate_virtual_file</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">diff_stack_label</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">kind</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'fake'</span></em>, <em class="sig-param"><span class="n">virtual_size</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">1024</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.generate_virtual_file" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate a virtual HDF5 file containing the meta data of the dataset, but not the actual
diffraction. Instead of the diffraction stack, either a dummy stack containing a constant only,
or a virtual dataset with external links to the actual data files is created. While the former
is useful for indexing using CrystFEL, the latter can serve to generate a file for quick preview.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>{str} --</strong><strong> [</strong><strong>description</strong><strong>]</strong> (<em>filename</em>) – </p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{str} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>kind</em>) – {‘fake’})</p></li>
<li><p><strong>{int} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>virtual_size</em>) – {1024})</p></li>
</ul>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><strong>NotImplementedError</strong> – [description]</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.get_map">
<code class="sig-name descname">get_map</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file</span></em>, <em class="sig-param"><span class="n">subset</span><span class="o">=</span><span class="default_value">'entry'</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference internal" href="#diffractem.map_image.MapImage" title="diffractem.map_image.MapImage">diffractem.map_image.MapImage</a><a class="headerlink" href="#diffractem.dataset.Dataset.get_map" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.get_meta">
<code class="sig-name descname">get_meta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">path</span><span class="o">=</span><span class="default_value">'/%/instrument/detector/collection/shutter_time'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.get_meta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.get_selection">
<code class="sig-name descname">get_selection</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">query</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">file_suffix</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'_sel.h5'</span></em>, <em class="sig-param"><span class="n">file_prefix</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">''</span></em>, <em class="sig-param"><span class="n">new_folder</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reset_id</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span> &#x2192; <a class="reference internal" href="#diffractem.dataset.Dataset" title="diffractem.dataset.Dataset">diffractem.dataset.Dataset</a><a class="headerlink" href="#diffractem.dataset.Dataset.get_selection" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a new dataset object by applying a selection. By default, returns all shots with selected == True.
Optionally, a different query string can be supplied (which leaves the selection unaffected).
The stored file names will be changed, to avoid collisions. This can be controlled with the file_suffix and
file_prefix parameters.
:param query: Optional query string, as in the select method
:param file_suffix: as in Dataset.change_filenames
:param file_prefix: as in Dataset.change_filenames
:param new_folder: as in Dataset.change_filenames
:return: new data set.</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.init_files">
<code class="sig-name descname">init_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">overwrite</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">keep_features</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">exclude_list</span><span class="o">=</span><span class="default_value">()</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.init_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Make new files corresponding to the shot list, by copying over instrument metadata and maps (but not
results, shot list, data arrays,…) from the raw files (as stored in file_raw).
:param overwrite: overwrite new files if not yet existing
:param keep_features: copy over the feature list from the files
:param exclude_list: custom list of HDF5 groups or datasets to exclude from copying
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.init_shot_table">
<code class="sig-name descname">init_shot_table</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">files</span><span class="p">:</span> <span class="n">list</span></em>, <em class="sig-param"><span class="n">stack_label</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'raw_counts'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.init_shot_table" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.init_stacks">
<code class="sig-name descname">init_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.init_stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens stacks briefly, to check their sizes etc., and closes them again right away. Helpful to just get their
names and sizes…
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.load_tables">
<code class="sig-name descname">load_tables</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">shots</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">features</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">peaks</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">predict</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">files</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.load_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>Load pandas metadata tables from the HDF5 files. Set the argument for the table you want to load to True.
:param shots: shot table
:param features: feature table
:param peaks: peak table
:param predict: prediction table
:param files: …allows to supply a custom file list, instead of the stored one. Dangerous.
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.merge_acquisition_data">
<code class="sig-name descname">merge_acquisition_data</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fields</span><span class="p">:</span> <span class="n">dict</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.merge_acquisition_data" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.merge_meta">
<code class="sig-name descname">merge_meta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">path</span><span class="o">=</span><span class="default_value">'%/instrument/detector/collection/shutter_time'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.merge_meta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.merge_pattern_info">
<code class="sig-name descname">merge_pattern_info</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">ds_from</span><span class="p">:</span> <span class="n"><a class="reference internal" href="#diffractem.dataset.Dataset" title="diffractem.dataset.Dataset">diffractem.dataset.Dataset</a></span></em>, <em class="sig-param"><span class="n">merge_cols</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>List<span class="p">[</span>str<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">by</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>List<span class="p">[</span>str<span class="p">]</span><span class="p">, </span>Tuple<span class="p">[</span>str<span class="p">]</span><span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'sample', 'region', 'run', 'crystal_id'</span></em>, <em class="sig-param"><span class="n">persist</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.merge_pattern_info" title="Permalink to this definition">¶</a></dt>
<dd><p>Merge shot table columns and peak data from another data set into this one, based
on matching of the shot table columns specified in “by”.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>{Dataset} -- Diffractem Dataset to take information from</strong> (<em>ds_from</em>) – </p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{List} -- Shot table columns to take over from other data set. If None</strong> (<em>merge_cols</em>) – all columns are taken over which are not present in the shot table currently</p></li>
<li><p><strong>{List} -- Shot table columns to match by.</strong> (<em>by</em>) – Defaults to [‘sample’, ‘region’, ‘run’, ‘crystal_id’]</p></li>
</ul>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><strong>ValueError</strong> – [description] d</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.merge_stream">
<code class="sig-name descname">merge_stream</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">streamfile</span><span class="p">:</span> <span class="n">Union<span class="p">[</span><a class="reference internal" href="#diffractem.stream_parser.StreamParser" title="diffractem.stream_parser.StreamParser">diffractem.stream_parser.StreamParser</a><span class="p">, </span>str<span class="p">]</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.merge_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>Loads a CrystFEL stream file, and merges its contents into the dataset object.
:param streamfile: file name of streamfile, or StreamParser object
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.open_stacks">
<code class="sig-name descname">open_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">labels</span><span class="p">:</span> <span class="n">Union[None, list]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">checklen</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">init</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">readonly</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">swmr</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">chunking</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>int<span class="p">, </span>str<span class="p">, </span>list<span class="p">, </span>tuple<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'dataset'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.open_stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Opens data stacks from HDF5 (NeXus) files (found by the “data_pattern” attribute), and assigns dask array
objects to them. After opening, the arrays or parts of them can be accessed through the stacks attribute,
or directly using a dataset.stack syntax, and loaded using the .compute() method of the arrays.
Note that, while the stacks are open, no other python kernel will be able to access the data files, and other
codes may not see the modifications made. You will have to call dataset.close_stacks() before.
:param labels: list of stacks to open. Default: None -&gt; opens all stacks
:param checklen: check if stack heights (first dimension) is equal to shot list length
:param init: do not load stacks, just make empty dask arrays. Usually the init_stacks method is more useful.
:param readonly: open HDF5 files in read-only mode (Default: True)
:param swmr: open HDF5 files in SWMR mode (Default: False)
:param chunking: how should the dask arrays be chunked along the 0th (stack) direction. Options are,</p>
<blockquote>
<div><p>in decreasing order of recommendation:
* None, which tries all good options and fails if none works
* ‘dataset’ to use what is set in the current dataset zchunks property (default)
* ‘existing’ to use the chunking of an already-existing stack which is about to be overwritten.</p>
<blockquote>
<div><p>Should usually be the same as ‘dataset’</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>‘hdf5’ to use the chunksize recommended in the HDF5 file (‘recommended_zchunks’ attribute) of the</dt><dd><p>data stacks group</p>
</dd>
</dl>
</li>
<li><p>an integer number for a defined (approximate) chunk size, which ignores shots with frame number &lt; -1,</p></li>
<li><p>an iterable to explicitly set the chunk sizes</p></li>
<li><p>‘auto’ to use the dask automatic mode</p></li>
</ul>
</div></blockquote>
<p>Generally, a fixed number (integer or iterable) is recommended and gives the least trouble.
already been chunked before. For a fixed number, the chunks are done such that after filtering of frame == -1 shots,
a constant chunk size is achieved.
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.peaks">
<em class="property">property </em><code class="sig-name descname">peaks</code><a class="headerlink" href="#diffractem.dataset.Dataset.peaks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.persist_stacks">
<code class="sig-name descname">persist_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">labels</span><span class="p">:</span> <span class="n">Union[None, str, list]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union[None, str, list]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">include_3d</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">scheduler</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>distributed.client.Client<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">'threading'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.persist_stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Persist the stacks to memory (locally and/or on the cluster workers), that is, they are computed.
but actually not changed to numpy arrays, just immediately available dask arrays without an actual
task graph. It is recommended to have as many stacks persisted as possible.
The diffraction data stack is automatically excluded.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>str</strong><strong>, </strong><strong>list</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>exclude</em>) – {None})</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>str</strong><strong>, </strong><strong>list</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> – {None})</p></li>
<li><p><strong>{bool} --</strong><strong> [</strong><strong>description</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>include_3d</em>) – {False})</p></li>
<li><p><strong>{} --</strong> (<em>scheduler</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.predict">
<em class="property">property </em><code class="sig-name descname">predict</code><a class="headerlink" href="#diffractem.dataset.Dataset.predict" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.rechunk_stacks">
<code class="sig-name descname">rechunk_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">chunk_height</span><span class="p">:</span> <span class="n">int</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.rechunk_stacks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.reset_id">
<code class="sig-name descname">reset_id</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">keep_raw</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.reset_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Resets shot_in_subset and Event columns to continuous numbering. Useful after dataset reduction. The old
Event strings are copied to a “Event_raw” column, if not already present (can be overriden with keep_raw).
:param keep_raw: if True (default), does not change the Event_raw column in the shot list,</p>
<blockquote>
<div><p>unless there is none yet (in which case the old Event IDs are _always_ copied to keep_raw)</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.select">
<code class="sig-name descname">select</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">query</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'True'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.select" title="Permalink to this definition">¶</a></dt>
<dd><p>Sets the ‘selected’ column of the shot list by a string query (eg. ‘num_peaks &gt; 30 and frame == 1’).
See pandas documentation for ‘query’ and ‘eval’. If you want to add another criterion to the existing
selection you can also do sth. like ‘selected and hit == 1’.
:param query: if left empty, defaults to ‘True’ -&gt; selects all shots.
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.shots">
<em class="property">property </em><code class="sig-name descname">shots</code><a class="headerlink" href="#diffractem.dataset.Dataset.shots" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.stacks">
<em class="property">property </em><code class="sig-name descname">stacks</code><a class="headerlink" href="#diffractem.dataset.Dataset.stacks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.stacks_to_shots">
<code class="sig-name descname">stacks_to_shots</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">stack_labels</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>list<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">shot_labels</span><span class="p">:</span> <span class="n">Union[str, list, None]</span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.stacks_to_shots" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.store_stack_fast">
<code class="sig-name descname">store_stack_fast</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">label</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">client</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>distributed.client.Client<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">sync</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">compression</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>int<span class="p">, </span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">32004</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.store_stack_fast" title="Permalink to this definition">¶</a></dt>
<dd><p>Store (and compute) a single stack to HDF5 file(s), using a dask.distributed cluster.
This allows for proper parallel computation (even on many machines) and is wa(aaa)y faster
than the standard store_stacks, which only works with threads.
It also sets the signal attribute in the NeXus-compliant data group to the given label.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>{str} -- Label of the stack to be computed and stored. If None</strong><strong>, </strong><strong>use the _diff_stack</strong> (<em>label</em>) – setting.</p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{Optional</strong><strong>[</strong><strong>Client</strong><strong>]</strong><strong>} -- dask.distributed client object. Mandatorily required</strong> (<em>client</em>) – if sync=True. (default: {None})</p></li>
<li><p><strong>{bool} -- if True</strong> (<em>sync</em>) – dataframe containing metadata of everything stored, for validation. If False,
returns a list of dask.delayed objects which encapsulate the computation/storage.</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>int</strong><strong>, </strong><strong>str</strong><strong>]</strong><strong>} -- Compression of the dataset to be stored.</strong> (<em>compression</em>) – Defaults to 32004, which is LZ4. Viable alternatives are ‘gzip’, ‘lzf’, or ‘none’.</p></li>
</ul>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><strong>ValueError</strong> – [description]</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>pd.DataFrame (if sync=True), list of dask.delayed (if sync=False)</p>
</dd>
</dl>
<dl class="simple">
<dt>Remarks:</dt><dd><p>If the stack to be stored depends on computationally heavy (but memory-fitting) dask
arrays which you want to retain outside this computation (e.g. to store them using
store_stacks), consider persisting them (using da.persist) before calling sthis function.
Otherwise, they will be re-calculated from scratch.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.store_stacks">
<code class="sig-name descname">store_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">labels</span><span class="p">:</span> <span class="n">Union[None, str, list]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="p">:</span> <span class="n">Union[None, str, list]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">overwrite</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">compression</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>int<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">32004</span></em>, <em class="sig-param"><span class="n">lazy</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">data_pattern</span><span class="p">:</span> <span class="n">Union[None, str]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">progress_bar</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">scheduler</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'threading'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.store_stacks" title="Permalink to this definition">¶</a></dt>
<dd><p>Stores stacks with given labels to the HDF5 data files. If None (default), stores all stacks. New stacks are
typically not yet computed, so at this point the actual data crunching is done. Note that this way of computing
and storing data is restricted to threading or single-threaded computation, i.e. it’s not recommended for
heavy lifting. In this case, better use store_stack_fast.
:param labels: stack(s) to be written
:param exclude: stack(s) to be excluded
:param overwrite: overwrite stacks already existing in the files?
:param compression: compression algorithm to be used. 32004 corresponds to bz4, which we mostly use.
:param lazy: if True, instead of writing the shots, returns two lists containing the arrays and dataset objects</p>
<blockquote>
<div><p>which can be used to later pass them to dask.array.store. Default False (store right away)</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>data_pattern</strong> – store stacks to this data path (% is replaced by subset) instead of standard path.
Note that stacks stored this way will not be retrievable through Dataset objects.</p></li>
<li><p><strong>progress_bar</strong> – show a progress bar during calculation/storing. Disable if you’re running store_stacks
in multiple processes simultaneously.</p></li>
<li><p><strong>scheduler</strong> – dask scheduler to be used. Can be ‘threading’ or ‘single-threaded’</p></li>
<li><p><strong>**kwargs</strong> – <p>will be forwarded to h5py.create_dataset</p>
</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.store_tables">
<code class="sig-name descname">store_tables</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">shots</span><span class="p">:</span> <span class="n">Union[None, bool]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">features</span><span class="p">:</span> <span class="n">Union[None, bool]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">peaks</span><span class="p">:</span> <span class="n">Union[None, bool]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">predict</span><span class="p">:</span> <span class="n">Union[None, bool]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">format</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'nexus'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.store_tables" title="Permalink to this definition">¶</a></dt>
<dd><p>Stores the metadata tables (shots, features, peaks, predictions) into HDF5 files. For each of the tables,
it can be automatically determined if they have changed and should be stored…
HOWEVER, this only works if no inplace changes have been made. So don’t rely on it too much.
:param shots: True -&gt; store shot list, False -&gt; don’t store shot list, None -&gt; only store if changed
:param features: similar
:param peaks: similar
:param predict: similar
:param format: format to write metadata tables. ‘nexus’ (recommended) or ‘tables’ (old-style)
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.transform_stack_groups">
<code class="sig-name descname">transform_stack_groups</code><span class="sig-paren">(</span><em class="sig-param">stacks: Union[List[str], str], func: Callable[[numpy.ndarray], numpy.ndarray] = &lt;function Dataset.&lt;lambda&gt;&gt;, by: Union[List[str], Tuple[str]] = ('sample', 'region', 'run', 'crystal_id')</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.transform_stack_groups" title="Permalink to this definition">¶</a></dt>
<dd><p>For all data stacks listed in stacks, transforms sub-stacks within groups defined by “by”.
As a common example, applies some function to all frames of a diffraction movie. The dimensions of
each sub-stack must not change in the process. Note that this happens in place, i.e., the stacks
will be overwritten by a transformed version.
A typical application is to calculate a cumulative sum of patterns wittin each diffraction movie. This
is what the default parameter for func is doing. Can do all kinds of other fun things, i.e. calculating
directly the difference between frames, the difference of each w.r.t. the first,
normalizing them to sth, etc.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>{List</strong><strong> or </strong><strong>str} -- Name</strong> (<em>stacks</em>) – </p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{Callable} -- Function applied to each sub-stack. Must act on a numpy</strong> (<em>func</em>) – array and return one of the same dimensions.
Defaults to: lambda x: np.cumsum(x, axis=0)</p></li>
<li><p><strong>{List} -- Shot table columns to identify groups.</strong> (<em>by</em>) – Defaults to [‘sample’, ‘region’, ‘run’, ‘crystal_id’]</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.write_list">
<code class="sig-name descname">write_list</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">listfile</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.dataset.Dataset.write_list" title="Permalink to this definition">¶</a></dt>
<dd><p>Writes the files in the dataset into a list file, containing each file on a line.
:param listfile: list file name
:return:</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.dataset.Dataset.zchunks">
<em class="property">property </em><code class="sig-name descname">zchunks</code><a class="headerlink" href="#diffractem.dataset.Dataset.zchunks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

</div>
<div class="section" id="module-diffractem.io">
<span id="diffractem-io-module"></span><h2>diffractem.io module<a class="headerlink" href="#module-diffractem.io" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.io.apply_shot_selection">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">apply_shot_selection</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">lists</span></em>, <em class="sig-param"><span class="n">stacks</span></em>, <em class="sig-param"><span class="n">min_chunk</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reset_shot_index</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.apply_shot_selection" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies the selection of shots as defined by the ‘selected’ column of the shot list, returning corresponding
subsets of both lists (pandas DataFrames) and stacks (dask arrays).
:param lists: flat dict of lists. Does not handle subsets, so use flat=True when reading from file
:param stacks: dict of arrays. Again, not accounting for subsets. Use flat=True for reading
:param min_chunk: minimum chunk size of the output arrays along the stacked dimension
:param reset_shot_index: if True, the returned shot list has its index reset, with correspondingly updated serial</p>
<blockquote>
<div><p>numbers in peak list. Recommended.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Return new_lists, new_stacks</dt>
<dd class="field-odd"><p>subselected lists and stacks</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.io.dict_to_h5">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">dict_to_h5</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">grp</span></em>, <em class="sig-param"><span class="n">data</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="o">=</span><span class="default_value">()</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.dict_to_h5" title="Permalink to this definition">¶</a></dt>
<dd><p>Write dictionary into HDF group (or file) object
:param grp: HDF group or file object
:param data: dictionary to be written into HDF5
:param exclude: dataset or group names to be excluded
:return:</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.io.expand_files">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">expand_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file_list</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>list<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">scan_shots</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">validate</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.expand_files" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.io.get_data_stacks">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">get_data_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">base_path</span><span class="o">=</span><span class="default_value">'/%/data'</span></em>, <em class="sig-param"><span class="n">labels</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.get_data_stacks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.io.get_meta_lists">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">get_meta_lists</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">base_path</span><span class="o">=</span><span class="default_value">'/%/data'</span></em>, <em class="sig-param"><span class="n">labels</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.get_meta_lists" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.io.h5_to_dict">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">h5_to_dict</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">grp</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="o">=</span><span class="default_value">'data', 'image'</span></em>, <em class="sig-param"><span class="n">max_len</span><span class="o">=</span><span class="default_value">100</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.h5_to_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>Get dictionary from HDF group (or file) object
:param grp: HDF group or file
:param exclude: (sub-)group or dataset names to be excluded; by default ‘data’ and ‘image
:param max_len: maximum length of data field to be included (along first direction)
:return: dictionary corresponding to HDF group</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.io.make_master_h5">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">make_master_h5</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file_list</span></em>, <em class="sig-param"><span class="n">file_name</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">abs_path</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">local_group</span><span class="o">=</span><span class="default_value">'/'</span></em>, <em class="sig-param"><span class="n">remote_group</span><span class="o">=</span><span class="default_value">'/entry'</span></em>, <em class="sig-param"><span class="n">verbose</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.make_master_h5" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.io.store_data_stacks">
<code class="sig-prename descclassname">diffractem.io.</code><code class="sig-name descname">store_data_stacks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">stacks</span></em>, <em class="sig-param"><span class="n">shots</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">base_path</span><span class="o">=</span><span class="default_value">'/%/data'</span></em>, <em class="sig-param"><span class="n">store_shots</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.io.store_data_stacks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-diffractem.legacy">
<span id="diffractem-legacy-module"></span><h2>diffractem.legacy module<a class="headerlink" href="#module-diffractem.legacy" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.legacy.diff_plot">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">diff_plot</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">idcs</span></em>, <em class="sig-param"><span class="n">setname</span><span class="o">=</span><span class="default_value">'centered'</span></em>, <em class="sig-param"><span class="n">beamdiam</span><span class="o">=</span><span class="default_value">1e-07</span></em>, <em class="sig-param"><span class="n">rings</span><span class="o">=</span><span class="default_value">10, 5, 2.5</span></em>, <em class="sig-param"><span class="n">radii</span><span class="o">=</span><span class="default_value">3, 4, 6</span></em>, <em class="sig-param"><span class="n">show_map</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">show_peaks</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">show_predict</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">figsize</span><span class="o">=</span><span class="default_value">15, 10</span></em>, <em class="sig-param"><span class="n">dpi</span><span class="o">=</span><span class="default_value">300</span></em>, <em class="sig-param"><span class="n">cutoff</span><span class="o">=</span><span class="default_value">99.5</span></em>, <em class="sig-param"><span class="n">width</span><span class="o">=</span><span class="default_value">616</span></em>, <em class="sig-param"><span class="n">xoff</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">yoff</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">ellipticity</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">map_px</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">clen</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">det_px</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">wavelength</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">stacks</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">shots</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">peaks</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">predict</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">base_path</span><span class="o">=</span><span class="default_value">'/%/data'</span></em>, <em class="sig-param"><span class="n">map_path</span><span class="o">=</span><span class="default_value">'/%/map/image'</span></em>, <em class="sig-param"><span class="n">results_path</span><span class="o">=</span><span class="default_value">'/%/results'</span></em>, <em class="sig-param"><span class="n">pre_compute</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">store_to</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">cmap</span><span class="o">=</span><span class="default_value">'gray'</span></em>, <em class="sig-param"><span class="n">ringcolor</span><span class="o">=</span><span class="default_value">'y'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.diff_plot" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.peak_finder">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">peak_finder</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img_raw</span></em>, <em class="sig-param"><span class="n">xy</span></em>, <em class="sig-param"><span class="n">profile</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">noise</span><span class="o">=</span><span class="default_value">array([[False, True, False], [True, True, True], [False, True, False]])</span></em>, <em class="sig-param"><span class="n">kernel_size</span><span class="o">=</span><span class="default_value">9</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">9</span></em>, <em class="sig-param"><span class="n">db_eps</span><span class="o">=</span><span class="default_value">1.9</span></em>, <em class="sig-param"><span class="n">db_samples</span><span class="o">=</span><span class="default_value">9</span></em>, <em class="sig-param"><span class="n">bkg_remove</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">img_clean</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">radial_min</span><span class="o">=</span><span class="default_value">5</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.peak_finder" title="Permalink to this definition">¶</a></dt>
<dd><ol class="arabic simple">
<li><dl class="simple">
<dt>(OPTIONAL) Construct background from xy and profile.</dt><dd><p>Subtract from img_raw.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Remove Impulse noise using morpholigical opening and closing with</dt><dd><p>noise struc.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Convolve Image with Gaussian kernel to find local background.</dt><dd><p>Features are all pixels larger than the local background
by a certain threshold.</p>
</dd>
</dl>
</li>
<li><p>Pick peaks out of image features using DBSCAN (Clustering)</p></li>
<li><p>Labelling of Peaks using ndimage</p></li>
</ol>
<p>6) (OPTIONAL) Clean image
Simple peakfinder built upon scipy.ndimage.
Uses a morpholgical opening to find features larger than size and higher
than threshold. The features are then labelled and the center of mass and
sum of each peak is returned in a numpy array.</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.process_stack">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">process_stack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">imgs</span></em>, <em class="sig-param"><span class="n">ops</span></em>, <em class="sig-param"><span class="n">execution</span><span class="o">=</span><span class="default_value">'threads'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.process_stack" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies correction function, or a pipeline thereof, to a stack of images, using different ways of execution.
Essentially very similar to map function of hyperspy.
:param imgs: 3D image stack or 2D single image
:param ops: function handle to processing function, or list/tuple thereof.
:param execution: method of execution. Options are</p>
<blockquote>
<div><p>‘threads’: process each image in parallel using threads
‘processes’: process each image in parallel using processes
‘stack’: pass the entire stack to the ops functions. All ops must be able to handle stack inputs
‘loop’: loop through the images. Use for debugging only!</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>kwargs</strong> – keyword arguments to be passed to the correction functions</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the processed stack/image</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.profile_classify">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">profile_classify</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">prof_stack</span></em>, <em class="sig-param"><span class="n">fit_record</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">show_plot</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">show_fit</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">refit</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">rescale</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">verbose</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">bin_min</span><span class="o">=</span><span class="default_value">5</span></em>, <em class="sig-param"><span class="n">bin_max</span><span class="o">=</span><span class="default_value">40</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.profile_classify" title="Permalink to this definition">¶</a></dt>
<dd><p>Takes the profile stack,
refits a 1D Lorentz distribution(Optional),
groups the profiles with the same shape and scale together,
takes the mean and std of the group,
plots all the profiles in the group on the same figure(Optional)
and returns them to the correct index in profile_ave and profile_std.
:param prof_stack   : stack of profiles
:fit_record         : array of parameters returned form the 2D lorentz fit
:show_plot          : switch for plotting the profiles
:refit              : switch for refitting of the profiles
:rescale            : if profiles should be scaled.</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.profile_classify_ML">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">profile_classify_ML</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">prof_stack</span></em>, <em class="sig-param"><span class="n">fit_record</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">show_plot</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">refit</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">rescale</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">verbose</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">bin_min</span><span class="o">=</span><span class="default_value">5</span></em>, <em class="sig-param"><span class="n">bin_max</span><span class="o">=</span><span class="default_value">40</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.profile_classify_ML" title="Permalink to this definition">¶</a></dt>
<dd><p>Takes the profile stack,
refits a 1D Lorentz distribution(Optional),
classifies the profiles with KMeans form sklearn.cluster,
NB MinibatchKMeans is not parrallelized
takes the mean, and returns them to the correct index in profile_ave.
:param prof_stack   : stack of profiles
:fit_record         : array of parameters returned form the 2D lorentz fit
:show_plot          : switch for plotting the profiles
:refit              : switch for refitting of the profiles
:rescale            : if profiles should be scaled.</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.reduce_stack">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">reduce_stack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">first_frame</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">last_frame</span><span class="o">=</span><span class="default_value">- 1</span></em>, <em class="sig-param"><span class="n">aggregate</span><span class="o">=</span><span class="default_value">'sum'</span></em>, <em class="sig-param"><span class="n">suffix</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="o">=</span><span class="default_value">()</span></em>, <em class="sig-param"><span class="n">threads</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">instrument_data</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">label</span><span class="o">=</span><span class="default_value">'raw_counts'</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.reduce_stack" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.legacy.region_plot">
<code class="sig-prename descclassname">diffractem.legacy.</code><code class="sig-name descname">region_plot</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file_name</span></em>, <em class="sig-param"><span class="n">regions</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">crystal_pos</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">peak_ct</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">beamdiam</span><span class="o">=</span><span class="default_value">1e-07</span></em>, <em class="sig-param"><span class="n">scanpx</span><span class="o">=</span><span class="default_value">2e-08</span></em>, <em class="sig-param"><span class="n">figsize</span><span class="o">=</span><span class="default_value">10, 10</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.legacy.region_plot" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-diffractem.map_image">
<span id="diffractem-map-image-module"></span><h2>diffractem.map_image module<a class="headerlink" href="#module-diffractem.map_image" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="diffractem.map_image.MapImage">
<em class="property">class </em><code class="sig-prename descclassname">diffractem.map_image.</code><code class="sig-name descname">MapImage</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">coordinates</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">basename</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">region_id</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">run_id</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">subset</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">sample</span><span class="o">=</span><span class="default_value">''</span></em>, <em class="sig-param"><span class="n">detector_file</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">flatten_meta</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py method">
<dt id="diffractem.map_image.MapImage.align_overview">
<code class="sig-name descname">align_overview</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">reference</span></em>, <em class="sig-param"><span class="n">show_plot</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">method</span><span class="o">=</span><span class="default_value">'ecc'</span></em>, <em class="sig-param"><span class="n">use_gradient</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">transfer_props</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.align_overview" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.coordinates">
<em class="property">property </em><code class="sig-name descname">coordinates</code><a class="headerlink" href="#diffractem.map_image.MapImage.coordinates" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.detector_file">
<em class="property">property </em><code class="sig-name descname">detector_file</code><a class="headerlink" href="#diffractem.map_image.MapImage.detector_file" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.export_scan_list">
<code class="sig-name descname">export_scan_list</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">delim</span><span class="o">=</span><span class="default_value">' '</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.export_scan_list" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.features">
<em class="property">property </em><code class="sig-name descname">features</code><a class="headerlink" href="#diffractem.map_image.MapImage.features" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.find_particles">
<code class="sig-name descname">find_particles</code><span class="sig-paren">(</span><em class="sig-param">show_plot=True</em>, <em class="sig-param">show_segments=True</em>, <em class="sig-param">return_images=False</em>, <em class="sig-param">thr_fun=&lt;function threshold_li&gt;</em>, <em class="sig-param">thr_offset=0</em>, <em class="sig-param">local=False</em>, <em class="sig-param">disk_size=49</em>, <em class="sig-param">two_pass=False</em>, <em class="sig-param">morph_method='legacy'</em>, <em class="sig-param">morph_disk=2</em>, <em class="sig-param">remove_carbon_lacing=False</em>, <em class="sig-param">segmentation_method='distance-watershed'</em>, <em class="sig-param">min_dist=8</em>, <em class="sig-param">picking_method='region-centroid'</em>, <em class="sig-param">beam_radius=5</em>, <em class="sig-param">**kwargs</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.find_particles" title="Permalink to this definition">¶</a></dt>
<dd><p>Crystal finding algorithm. Attempts to find images in 4 steps:
(1) thresholding, yielding a binarized image. Can be done using a global or local (adaptive) threshold.</p>
<blockquote>
<div><p>Usually, global works better for STEM images, unless the background is very inhomogeneous. If there are
bright-ish “blobs” containing the particles, two_pass should be used.</p>
</div></blockquote>
<ol class="arabic simple" start="2">
<li><p>morphological operations, eliminating small features, filling holes etc.. Different sequences of operations
are provided which are worth trying out</p></li>
<li><p>segmentation of the bright regions found by the previous steps, using watershed or random walker schemes</p></li>
<li><p>generation of crystal coordinates, either using segment centroids, or by filling up the segments with a
number of points derived from a typical spacing (beam radius)</p></li>
</ol>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>show_plot</strong> – show a plot in the end to assess the result</p></li>
<li><p><strong>show_segments</strong> – show segments in the plot. Helps, but can be slow</p></li>
<li><p><strong>return_images</strong> – return the intermediate-step images from the function</p></li>
<li><p><strong>thr_fun</strong> – function used for global thresholding. Anything that takes the image as only positional argument
can be inserted here (e.g. those from skimage.filters.thresholding). Defaults to threshold_li</p></li>
<li><p><strong>thr_offset</strong> – additional offset for found global threshold. Note that the images are normalized to the
full 16bit range initially, so typically this value is in the range of 1000s</p></li>
<li><p><strong>local</strong> – use local thresholding instead, using the threshold_local function in skimage.filters. Usually
a global threshold with two_pass=True works better.</p></li>
<li><p><strong>disk_size</strong> – averaging disk range, when local=True</p></li>
<li><p><strong>two_pass</strong> – use a two-pass thresholding scheme, where after thresholding and morphological filtering, a
separate local threshold is found for each bright region. Then the thresholding is repeated. Often this
is far superior to using a local threshold.</p></li>
<li><p><strong>morph_method</strong> – selects a sequence of morphological operations. Current options are ‘legacy’ and
‘instamatic’, the latter derived from Stef Smeets’ instamatic package. Just try what works best.</p></li>
<li><p><strong>morph_disk</strong> – disk radius for morphological operations.</p></li>
<li><p><strong>remove_carbon_lacing</strong> – attempts to remove lacey carbon artifacts. Only works if morph_method is set
to ‘instamatic’</p></li>
<li><p><strong>segmentation_method</strong> – method for segmentation. Options are ‘distance-watershed’, ‘intensity-watershed’,
and ‘random-walker’. The latter is not well tested yet. Usually, ‘distance-watershed’ is better for clearly
visible particles that aggregate slightly, and ‘intensity-watershed’ for particles within larger blobs.</p></li>
<li><p><strong>min_dist</strong> – minimum distance between initial points for segmentation. Ideally corresponds to minimum
distance between crystals. Not used for random walker segmentation.</p></li>
<li><p><strong>picking_method</strong> – ‘region-centroid’ and ‘intensity-centroid’ will place a single coordinate marker for
acquisition into each segment; the latter weighs the pixels by their intensity. ‘k-means’ will place
many coordinate markers on the segment, approximately spaced by beam_radius/2; this is the ‘brute-force’
option.</p></li>
<li><p><strong>beam_radius</strong> – spacing between coordinates when using ‘brute-force’ acquisition</p></li>
<li><p><strong>kwargs</strong> – </p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>various intermediate images (img, binarized, morph, label_image, labels) if return_images=True</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.from_files">
<code class="sig-name descname">from_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">basename</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.from_files" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.from_nxs">
<em class="property">classmethod </em><code class="sig-name descname">from_nxs</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">subset</span><span class="o">=</span><span class="default_value">'entry'</span></em>, <em class="sig-param"><span class="n">map_grp</span><span class="o">=</span><span class="default_value">'map'</span></em>, <em class="sig-param"><span class="n">diffdata_grp</span><span class="o">=</span><span class="default_value">'data'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.from_nxs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.get_regionprops">
<code class="sig-name descname">get_regionprops</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.get_regionprops" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.img">
<em class="property">property </em><code class="sig-name descname">img</code><a class="headerlink" href="#diffractem.map_image.MapImage.img" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.img_scatter_plot">
<code class="sig-name descname">img_scatter_plot</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">ax</span></em>, <em class="sig-param"><span class="n">colors</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.img_scatter_plot" title="Permalink to this definition">¶</a></dt>
<dd><p>Tool function to make a nice combined scatter and stem figure plot.
:param ax: matplotlib axes object to plot into. Mandatory.
:param colors: list of color values to be used for the scatter plot. Can be used to get consistent dot colors</p>
<blockquote>
<div><p>between many images (e.g. to check if tracking works)</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>colors (colors used for the scatter points), imgh (handle to image plot), scath (handle to scatter plot)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.make_mask">
<code class="sig-name descname">make_mask</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">offset_x</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">offset_y</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">spotsize</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">pattern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">init_cols</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">binary_fn</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.make_mask" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.make_scan_list">
<code class="sig-name descname">make_scan_list</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">offset_x</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">offset_y</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">frames</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">y_pos_tol</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">predist</span><span class="o">=</span><span class="default_value">100</span></em>, <em class="sig-param"><span class="n">dxmax</span><span class="o">=</span><span class="default_value">300</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.make_scan_list" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.meta">
<em class="property">property </em><code class="sig-name descname">meta</code><a class="headerlink" href="#diffractem.map_image.MapImage.meta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.meta_diff">
<em class="property">property </em><code class="sig-name descname">meta_diff</code><a class="headerlink" href="#diffractem.map_image.MapImage.meta_diff" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.shots">
<em class="property">property </em><code class="sig-name descname">shots</code><a class="headerlink" href="#diffractem.map_image.MapImage.shots" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.subset">
<em class="property">property </em><code class="sig-name descname">subset</code><a class="headerlink" href="#diffractem.map_image.MapImage.subset" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.to_files">
<code class="sig-name descname">to_files</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">basename</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.to_files" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.map_image.MapImage.to_nxs">
<code class="sig-name descname">to_nxs</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">subset</span><span class="o">=</span><span class="default_value">'entry'</span></em>, <em class="sig-param"><span class="n">map_grp</span><span class="o">=</span><span class="default_value">'map'</span></em>, <em class="sig-param"><span class="n">diffdata_grp</span><span class="o">=</span><span class="default_value">'data'</span></em>, <em class="sig-param"><span class="n">store_diff_meta</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.MapImage.to_nxs" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py function">
<dt id="diffractem.map_image.align_ecc">
<code class="sig-prename descclassname">diffractem.map_image.</code><code class="sig-name descname">align_ecc</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">img_ref</span></em>, <em class="sig-param"><span class="n">method</span><span class="o">=</span><span class="default_value">'ecc'</span></em>, <em class="sig-param"><span class="n">mode</span><span class="o">=</span><span class="default_value">'affine'</span></em>, <em class="sig-param"><span class="n">coords</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">rescale</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">use_gradient</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.align_ecc" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.map_image.whiten">
<code class="sig-prename descclassname">diffractem.map_image.</code><code class="sig-name descname">whiten</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">obs</span></em>, <em class="sig-param"><span class="n">check_finite</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.map_image.whiten" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Adapted from c:/python27/lib/site-packages/skimage/filters/thresholding.py</dt><dd><p>to return array and std_dev</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-diffractem.nexus">
<span id="diffractem-nexus-module"></span><h2>diffractem.nexus module<a class="headerlink" href="#module-diffractem.nexus" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.nexus.copy_h5">
<code class="sig-prename descclassname">diffractem.nexus.</code><code class="sig-name descname">copy_h5</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fn_from</span></em>, <em class="sig-param"><span class="n">fn_to</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="o">=</span><span class="default_value">'%/detector/data', '/%/data/%', '/%/results/%'</span></em>, <em class="sig-param"><span class="n">mode</span><span class="o">=</span><span class="default_value">'w-'</span></em>, <em class="sig-param"><span class="n">print_skipped</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">h5_folder</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">h5_suffix</span><span class="o">=</span><span class="default_value">'.h5'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.nexus.copy_h5" title="Permalink to this definition">¶</a></dt>
<dd><p>Copies datasets h5/nxs files or lists of them to new ones, with exclusion of datasets.
:param fn_from: single h5/nxs file or list file
:param fn_to: new file name, or new list file. If the latter, specify with h5_folder and h5_suffix how the new names</p>
<blockquote>
<div><p>are supposed to be constructed</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exclude</strong> – patterns for data sets to be excluded. All regular expressions are allowed, % is mapped to .*
(i.e., any string of any length), for compatibility with CrystFEL</p></li>
<li><p><strong>mode</strong> – mode in which new files are opened. By default w-, i.e., files are created, but never overwritten</p></li>
<li><p><strong>print_skipped</strong> – print the skipped data sets, for debugging</p></li>
<li><p><strong>h5_folder</strong> – if operating on a list: folder where new h5 files should go</p></li>
<li><p><strong>h5_suffix</strong> – if operating on a list: suffix appended to old files (after stripping their extension)</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.nexus.get_meta_fields">
<code class="sig-prename descclassname">diffractem.nexus.</code><code class="sig-name descname">get_meta_fields</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">files</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>str<span class="p">, </span>list<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">dataset_paths</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>list<span class="p">, </span>str<span class="p">, </span>tuple<span class="p">, </span>dict<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">shorten_labels</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.nexus.get_meta_fields" title="Permalink to this definition">¶</a></dt>
<dd><p>Get arbitrary meta data from files.
:param files:
:param dataset_paths: list of dataset paths, or dict of structure {dataset: default value}
:param shorten_labels: only use final section of labels for columns of returned DataFrame
:return: pandas DataFrame of metadata</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.nexus.get_table">
<code class="sig-prename descclassname">diffractem.nexus.</code><code class="sig-name descname">get_table</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">files</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>list<span class="p">, </span>str<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">path</span><span class="o">=</span><span class="default_value">'/%/shots'</span></em>, <em class="sig-param"><span class="n">parallel</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span> &#x2192; pandas.core.frame.DataFrame<a class="headerlink" href="#diffractem.nexus.get_table" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.nexus.meta_to_nxs">
<code class="sig-prename descclassname">diffractem.nexus.</code><code class="sig-name descname">meta_to_nxs</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">meta</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exclude</span><span class="o">=</span><span class="default_value">'Detector'</span></em>, <em class="sig-param"><span class="n">meta_grp</span><span class="o">=</span><span class="default_value">'/entry/instrument'</span></em>, <em class="sig-param"><span class="n">data_grp</span><span class="o">=</span><span class="default_value">'/entry/data'</span></em>, <em class="sig-param"><span class="n">data_field</span><span class="o">=</span><span class="default_value">'raw_counts'</span></em>, <em class="sig-param"><span class="n">data_location</span><span class="o">=</span><span class="default_value">'/entry/instrument/detector/data'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.nexus.meta_to_nxs" title="Permalink to this definition">¶</a></dt>
<dd><p>Merges a dict containing metadata information for a serial data acquisition into an existing detector nxs file.
Additionally, it adds a soft link to the actual data for easier retrieval later (typically into /entry/data)
:param filename: NeXus file or lists
:param meta: can be set to {} -&gt; no meta action performed. Or a JSON file name. If None, a JSON file name will be</p>
<blockquote>
<div><p>derived from nxs_file by replacing .nxs by .json (useful in loops)</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>exclude</strong> – names of meta groups or fields to exclude</p></li>
<li><p><strong>meta_grp</strong> – location in the NeXus, where the metadata should go to</p></li>
<li><p><strong>data_grp</strong> – location of softlink to the data stack. No softlink action if None.</p></li>
<li><p><strong>data_field</strong> – name of the softlink to the data stack</p></li>
<li><p><strong>data_location</strong> – location of the data stack</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.nexus.store_table">
<code class="sig-prename descclassname">diffractem.nexus.</code><code class="sig-name descname">store_table</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">table</span><span class="p">:</span> <span class="n">pandas.core.frame.DataFrame</span></em>, <em class="sig-param"><span class="n">path</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">parallel</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em>, <em class="sig-param"><span class="n">format</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'nexus'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.nexus.store_table" title="Permalink to this definition">¶</a></dt>
<dd><p>Stores a pandas DataFrame containing ‘file’ and ‘subset’ columns to multiple HDF5 files. Essentially a
multi-file, multi-processed wrapper to pd.to_hdf
:param table: DataFrame to be stored
:param path: path in HDF5 files. % will be substituted by the respective subset name
:param parallel: if True (default), writes files in parallel
:param format: can be ‘nexus’ to write columns of table in separate arrays, or ‘tables’ to use PyTables to write</p>
<blockquote>
<div><p>a HDF5 table object.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>list of futures (see documentation of concurrent.futures). [None] if parallel=False</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-diffractem.pre_proc_opts">
<span id="diffractem-pre-proc-opts-module"></span><h2>diffractem.pre_proc_opts module<a class="headerlink" href="#module-diffractem.pre_proc_opts" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="diffractem.pre_proc_opts.PreProcOpts">
<em class="property">class </em><code class="sig-prename descclassname">diffractem.pre_proc_opts.</code><code class="sig-name descname">PreProcOpts</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fn</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.agg_file_suffix">
<code class="sig-name descname">agg_file_suffix</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.agg_file_suffix" title="Permalink to this definition">¶</a></dt>
<dd><p>file suffix for aggregated patterns</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.agg_query">
<code class="sig-name descname">agg_query</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.agg_query" title="Permalink to this definition">¶</a></dt>
<dd><p>query string for aggregation of patterns</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.aggregate">
<code class="sig-name descname">aggregate</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.aggregate" title="Permalink to this definition">¶</a></dt>
<dd><p>calculate aggregated patterns</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.cam_length">
<code class="sig-name descname">cam_length</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.cam_length" title="Permalink to this definition">¶</a></dt>
<dd><p>Coarse camera length (in m) for estimations. Not used for indexing</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.com_xrng">
<code class="sig-name descname">com_xrng</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.com_xrng" title="Permalink to this definition">¶</a></dt>
<dd><p>x range (px) around pattern center in which to look for center of mass</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.com_yrng">
<code class="sig-name descname">com_yrng</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.com_yrng" title="Permalink to this definition">¶</a></dt>
<dd><p>y range (px) around pattern center in which to look for center of mass</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.correct_saturation">
<code class="sig-name descname">correct_saturation</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.correct_saturation" title="Permalink to this definition">¶</a></dt>
<dd><p>Correct for detector saturation using paralyzable model</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.dead_time">
<code class="sig-name descname">dead_time</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.dead_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Dead time (in ms) for paralyzable detector model</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.indexing_params">
<code class="sig-name descname">indexing_params</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.indexing_params" title="Permalink to this definition">¶</a></dt>
<dd><p>indexamajig parameters for indexing (of virtual files)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.integration_params">
<code class="sig-name descname">integration_params</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.integration_params" title="Permalink to this definition">¶</a></dt>
<dd><p>indexamajig parameters for integration</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.pre_proc_opts.PreProcOpts.load">
<code class="sig-name descname">load</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fn</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.load" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.lorentz_maxshift">
<code class="sig-name descname">lorentz_maxshift</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.lorentz_maxshift" title="Permalink to this definition">¶</a></dt>
<dd><p>maximum shift (px) of Lorentz fit center from center of mass</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.lorentz_radius">
<code class="sig-name descname">lorentz_radius</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.lorentz_radius" title="Permalink to this definition">¶</a></dt>
<dd><p>radius (px) around center of mass for Lorentz fit of zero order</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.max_peaks">
<code class="sig-name descname">max_peaks</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.max_peaks" title="Permalink to this definition">¶</a></dt>
<dd><p>maximum number of peaks for peak finding</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.peak_search_params">
<code class="sig-name descname">peak_search_params</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.peak_search_params" title="Permalink to this definition">¶</a></dt>
<dd><p>parameters for peak finding using peakfinder8</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.pixel_size">
<code class="sig-name descname">pixel_size</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.pixel_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Pixel size (in m)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.proc_dir">
<code class="sig-name descname">proc_dir</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.proc_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>directory for pre-processed data</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.pxmask">
<code class="sig-name descname">pxmask</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.pxmask" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of pixelmask TIF image</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.r_adf1">
<code class="sig-name descname">r_adf1</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.r_adf1" title="Permalink to this definition">¶</a></dt>
<dd><p>inner/outer radii for virtual ADF 1 (px)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.r_adf2">
<code class="sig-name descname">r_adf2</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.r_adf2" title="Permalink to this definition">¶</a></dt>
<dd><p>inner/outer radii for virtual ADF 2 (px)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.reference">
<code class="sig-name descname">reference</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.reference" title="Permalink to this definition">¶</a></dt>
<dd><p>Name of reference image for flat-field correction in TIF format</p>
</dd></dl>

<dl class="py method">
<dt id="diffractem.pre_proc_opts.PreProcOpts.save">
<code class="sig-name descname">save</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fn</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.save" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.scratch_dir">
<code class="sig-name descname">scratch_dir</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.scratch_dir" title="Permalink to this definition">¶</a></dt>
<dd><p>scratch directory for temporary data</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.select_query">
<code class="sig-name descname">select_query</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.select_query" title="Permalink to this definition">¶</a></dt>
<dd><p>query string for selection of shots from raw data</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.shutter_time">
<code class="sig-name descname">shutter_time</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.shutter_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Shutter time (in ms) for paralyzable detector model</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.xsize">
<code class="sig-name descname">xsize</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.xsize" title="Permalink to this definition">¶</a></dt>
<dd><p>x image size (px)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.y_scale">
<code class="sig-name descname">y_scale</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.y_scale" title="Permalink to this definition">¶</a></dt>
<dd><p>Scaling of camera length along y axis (tilted detector)</p>
</dd></dl>

<dl class="py attribute">
<dt id="diffractem.pre_proc_opts.PreProcOpts.ysize">
<code class="sig-name descname">ysize</code><em class="property"> = None</em><a class="headerlink" href="#diffractem.pre_proc_opts.PreProcOpts.ysize" title="Permalink to this definition">¶</a></dt>
<dd><p>y image size (px)</p>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="diffractem-pre-process-module">
<h2>diffractem.pre_process module<a class="headerlink" href="#diffractem-pre-process-module" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="module-diffractem.proc2d">
<span id="diffractem-proc2d-module"></span><h2>diffractem.proc2d module<a class="headerlink" href="#module-diffractem.proc2d" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.proc2d.apply_flatfield">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">apply_flatfield</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">reference</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">keep_type</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">ref_smooth_range</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">normalize_reference</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.apply_flatfield" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies a flatfield (gain reference) image to a single image or stack.
:param img              : Input image or image stack
:param reference        : Gain reference image (usually normalized to 1)
:param keep_type        : Keep integer data type of the initial image,</p>
<blockquote>
<div><p>: even if it requires rounding</p>
</div></blockquote>
<p>:param ref_smooth_range : Optionally, smooth the reference image out
:param normalize_reference</p>
<blockquote>
<div><p>: Optionally, re-normalize the image</p>
</div></blockquote>
<p>:param kwargs           : Nothing, currently
:return                 : Corrected image</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.apply_saturation_correction">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">apply_saturation_correction</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">exp_time</span><span class="p">:</span> <span class="n">float</span></em>, <em class="sig-param"><span class="n">dead_time</span><span class="p">:</span> <span class="n">float</span> <span class="o">=</span> <span class="default_value">0.0019</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.apply_saturation_correction" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply detector correction function to image. Should ideally be done even before flatfield.
Uses a 5th order polynomial approximation to the Lambert function, which is appropriate
for a paralyzable detector, up to the point where its signal starts inverting (which is where
nothing can be done anymore)</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{np.ndarray} -- Input image</strong><strong> or </strong><strong>image stack</strong> (<em>img</em>) – </p></li>
<li><p><strong>{float} -- Exposure time in ms</strong> (<em>exp</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><p><strong>{float} -- Dead time of detector in ms</strong><strong> (</strong><strong>default</strong> (<a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts.dead_time" title="diffractem.pre_proc_opts.PreProcOpts.dead_time"><em>dead_time</em></a>) – {1.9e-3})</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.apply_virtual_detector">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">apply_virtual_detector</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">stack</span></em>, <em class="sig-param"><span class="n">r_inner</span></em>, <em class="sig-param"><span class="n">r_outer</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.apply_virtual_detector" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply a “virtual STEM detector” to stack, with given inner and outer radii. Returns the mean value of all pixels
that fall inside this annulus.</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.center_image">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">center_image</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">imgs</span></em>, <em class="sig-param"><span class="n">x0</span></em>, <em class="sig-param"><span class="n">y0</span></em>, <em class="sig-param"><span class="n">xsize</span></em>, <em class="sig-param"><span class="n">ysize</span></em>, <em class="sig-param"><span class="n">padval</span></em>, <em class="sig-param"><span class="n">parallel</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.center_image" title="Permalink to this definition">¶</a></dt>
<dd><p>Centers a whole stack of images. See center_sgl_image for details… now, imgs is a 3D stack,
x0 and y0 are 1d arrays. imgs can be a dask array, map_blocks is automatically invoked then</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.center_of_mass">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">center_of_mass</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">0.0</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.center_of_mass" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the center of mass of an image using all the pixels larger than
the threshold. Automatically skips values below threshold. Fast for sparse
images.
:param img              : Input image
:param threshold        : minimum pixel value to include
:return (x0,y0)         :Return location</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.center_of_mass2">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">center_of_mass2</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.center_of_mass2" title="Permalink to this definition">¶</a></dt>
<dd><p>Alternative COM function, acting on 3D arrays directly,
including lazy dask arrays. Tends to be slower than center_of_mass for
sparse images with high thresholds, otherwise faster.
:param img:
:return:</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.correct_dead_pixels">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">correct_dead_pixels</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>numpy.ndarray<span class="p">, </span>str<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">strategy</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'interpolate'</span></em>, <em class="sig-param"><span class="n">interp_range</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">1</span></em>, <em class="sig-param"><span class="n">replace_val</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>float<span class="p">, </span>int<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">mask_gaps</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">edge_mask_x</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">70</span></em>, <em class="sig-param"><span class="n">edge_mask_y</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">0</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.correct_dead_pixels" title="Permalink to this definition">¶</a></dt>
<dd><p>Corrects a set of images for dead pixels by either replacing values with a
constant (e.g. for Diffraction Analysis with mask support), or
interpolation from a Gaussian-smoothed version of the image (e.g. for SPA
or general imaging). It requires a binary array (pxmask) which is
1/255/True for dead pixels. The function accepts a 3D array where the first
dimension corresponds to a stack/movie. The convolution used for the Gauss
filter is taken from the astropy package, which allows to ignore NaNs.
While the function does support stacks, this may be slow, especially with
interpolation. In these cases, better apply to single images in parallel
(e.g. using diffractem.compute.process_stack).
:param img      : the image or image stack (first dimension is stack)</p>
<blockquote>
<div><p>: to process. For replace strategy it can be a dask array.</p>
</div></blockquote>
<dl class="simple">
<dt>:param pxmask<span class="classifier">pixel mask with dimension of the image, or TIF file</span></dt><dd><p>: containing pixel mask</p>
</dd>
<dt>:param strategy<span class="classifier">‘replace’ with constant or ‘interpolate’ with smoothed</span></dt><dd><p>: adjacent region</p>
</dd>
<dt>:param interp_range<span class="classifier">range over which interpolation pixels are calculated</span></dt><dd><p>: (if strategy is ‘interpolate’)</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>replace_val</strong> – value with which dead pixels are replaced
: (if strategy is ‘replace’)</p></li>
<li><p><strong>mask_gaps</strong> – treat the interpolated pixels between the panels as dead</p></li>
<li><p><strong>edge_mask_</strong><strong>[</strong><strong>x/y</strong><strong>]</strong> – number of pixels at outer [left/right]/[upper/lower] edges to treat as
: dead (because of shading)</p></li>
</ul>
</dd>
</dl>
<p>:param kwargs   : not doing anything so far
:return         : corrected image</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.correct_image">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">correct_image</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>numpy.ndarray<span class="p">, </span>dask.array.core.Array<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">opts</span><span class="p">:</span> <span class="n"><a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts" title="diffractem.pre_proc_opts.PreProcOpts">diffractem.pre_proc_opts.PreProcOpts</a></span></em>, <em class="sig-param"><span class="n">x0</span><span class="p">:</span> <span class="n">Union[None, numpy.ndarray, dask.array.core.Array, pandas.core.series.Series]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">y0</span><span class="p">:</span> <span class="n">Union[None, numpy.ndarray, dask.array.core.Array, pandas.core.series.Series]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">peakinfo</span><span class="p">:</span> <span class="n">Union[None, Dict[str, Union[numpy.ndarray, dask.array.core.Array]]]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reference</span><span class="p">:</span> <span class="n">Union[None, numpy.ndarray, str]</span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="p">:</span> <span class="n">Union[None, numpy.ndarray, str]</span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span> &#x2192; Union<span class="p">[</span>numpy.ndarray<span class="p">, </span>dask.array.core.Array<span class="p">]</span><a class="headerlink" href="#diffractem.proc2d.correct_image" title="Permalink to this definition">¶</a></dt>
<dd><p>Runs correction pipeline on stack of diffraction images (numpy or dask). The pipeline comprises
flat-field, saturation and dead-pixel correction, as well as background subtraction, optionally
including peak exclusion (recommended).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{Union</strong><strong>[</strong><strong>np.ndarray</strong><strong>, </strong><strong>da.Array</strong><strong>]</strong><strong>} -- Diffraction pattern stack</strong> (<em>img</em>) – </p></li>
<li><p><strong>{PreProcOpts} -- Pre-processing options. Options used are</strong> (<em>opts</em>) – (…)</p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>np.ndarray</strong><strong>, </strong><strong>da.Array</strong><strong>]</strong><strong>} -- Pattern X centers</strong> (<em>x0</em>) – (default: use image center)</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>np.ndarray</strong><strong>, </strong><strong>da.Array</strong><strong>]</strong><strong>} -- Pattern Y centers</strong> (<em>y0</em>) – (default: use image center)</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>Dict</strong><strong>[</strong><strong>Union</strong><strong>[</strong><strong>np.ndarray</strong><strong>, </strong><strong>da.Array</strong><strong>]</strong><strong>]</strong><strong>]</strong><strong>} -- Diffraction peak dict in CXI format</strong> (<em>peakinfo</em>) – (default: no peak exclusion during background subtraction)</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>Union</strong><strong>[</strong><strong>np.ndarray</strong><strong>, </strong><strong>str</strong><strong>]</strong><strong>]</strong><strong>} -- Flat-field reference</strong> (<a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts.reference" title="diffractem.pre_proc_opts.PreProcOpts.reference"><em>reference</em></a>) – (default: use reference file specified in options)</p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>None</strong><strong>, </strong><strong>Union</strong><strong>[</strong><strong>np.ndarray</strong><strong>, </strong><strong>str</strong><strong>]</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>]</strong> (<a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts.pxmask" title="diffractem.pre_proc_opts.PreProcOpts.pxmask"><em>pxmask</em></a>) – (default: use pixel mask file specified in options)</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>[Union[np.ndarray, da.Array]] – Corrected diffraction image stack.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This function essentially wraps proc2d._compute_corr_image. If you want to change the
correction pipeline, that is the function to modify.</p>
</div>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.cut_peaks">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">cut_peaks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">nPeaks</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">peakXPosRaw</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">peakYPosRaw</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">radius</span><span class="o">=</span><span class="default_value">2</span></em>, <em class="sig-param"><span class="n">replaceval</span><span class="o">=</span><span class="default_value">- 1</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.cut_peaks" title="Permalink to this definition">¶</a></dt>
<dd><p>Cuts peaks out of an image and replaces them with replaceval.
Peak positions are provided in CXI format.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{np.array} -- Input image</strong> (<em>img</em>) – </p></li>
<li><p><strong>{np.array} -- Number of peaks</strong> (<em>nPeaks</em>) – </p></li>
<li><p><strong>{np.array} -- X position of peaks</strong> (<em>peakXPosRaw</em>) – </p></li>
<li><p><strong>{np.array} -- Y position of peaks</strong> (<em>peakYPosRaw</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{int} -- Radius in pixel of peak cut-out region</strong><strong> (</strong><strong>default</strong> (<em>radius</em>) – {2})</p></li>
<li><p><strong>{int} -- Value to change the cut pixels to</strong><strong> (</strong><strong>default</strong> (<em>replaceval</em>) – {-1})</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>[as img] – Image with peaks cut out</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.func_lorentz">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">func_lorentz</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">x</span></em>, <em class="sig-param"><span class="n">y</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.func_lorentz" title="Permalink to this definition">¶</a></dt>
<dd><p>Function that returns a Student’t distribution or generalised Cauchy
distribution in Two Dimensions(x,y).
:param p    :  [amp x_0 y_0 scale shape]
:param x    : x coordinate
:param y    : y coordinate</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.get_pattern_info">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">get_pattern_info</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">opts</span><span class="p">:</span> <span class="n"><a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts" title="diffractem.pre_proc_opts.PreProcOpts">diffractem.pre_proc_opts.PreProcOpts</a></span></em>, <em class="sig-param"><span class="n">client</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>distributed.client.Client<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">reference</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>numpy.ndarray<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>numpy.ndarray<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">lazy</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">False</span></em>, <em class="sig-param"><span class="n">sync</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span> &#x2192; Tuple<span class="p">[</span>pandas.core.frame.DataFrame<span class="p">, </span>dict<span class="p">]</span><a class="headerlink" href="#diffractem.proc2d.get_pattern_info" title="Permalink to this definition">¶</a></dt>
<dd><p>PATTERN PROCESSING MACRO
…returns a DataFrame + dict!
get_pattern_info computes information on a given diffraction pattern or stack thereof
(as 3D numpy array), returned as a dask.delayed object that computes to a dictionary.
It can be altered as required, but in this incarnation it computes center of mass,
Parameters of a Lorentzian fit, Pattern center as determined from Friedel pair
matching, and Found peaks using peakfinder8 in CXI format (as a sub-dict).</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.get_peaks">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">get_peaks</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">x0</span><span class="p">:</span> <span class="n">float</span></em>, <em class="sig-param"><span class="n">y0</span><span class="p">:</span> <span class="n">float</span></em>, <em class="sig-param"><span class="n">max_peaks</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">500</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>numpy.ndarray<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">min_snr</span><span class="p">:</span> <span class="n">float</span> <span class="o">=</span> <span class="default_value">4.0</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="p">:</span> <span class="n">float</span> <span class="o">=</span> <span class="default_value">8</span></em>, <em class="sig-param"><span class="n">min_pix_count</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">2</span></em>, <em class="sig-param"><span class="n">max_pix_count</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">20</span></em>, <em class="sig-param"><span class="n">local_bg_radius</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">3</span></em>, <em class="sig-param"><span class="n">min_res</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">0</span></em>, <em class="sig-param"><span class="n">max_res</span><span class="p">:</span> <span class="n">int</span> <span class="o">=</span> <span class="default_value">500</span></em>, <em class="sig-param"><span class="n">as_dict</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span> &#x2192; numpy.ndarray<a class="headerlink" href="#diffractem.proc2d.get_peaks" title="Permalink to this definition">¶</a></dt>
<dd><p>Find peaks in diffraction pattern using the peakfinder8 algorithm as used in
CrystFEL, OnDA and Cheetah. Requires installation of OnDA.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>-- Input image</strong><strong> or </strong><strong>stack</strong> (<em>img</em>) – </p></li>
<li><p><strong>-- Beam center along x</strong> (<em>x0</em>) – </p></li>
<li><p><strong>-- Beam center along y</strong> (<em>y0</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{int} -- Maximum number of peaks</strong><strong> (</strong><strong>default</strong> (<a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts.max_peaks" title="diffractem.pre_proc_opts.PreProcOpts.max_peaks"><em>max_peaks</em></a>) – {500})</p></li>
<li><p><strong>{float} -- Pixel mask. Pixels with value greater than 0 are ignored.</strong><strong> (</strong><strong>default</strong> (<a class="reference internal" href="#diffractem.pre_proc_opts.PreProcOpts.pxmask" title="diffractem.pre_proc_opts.PreProcOpts.pxmask"><em>pxmask</em></a>) – {None})</p></li>
<li><p><strong>{float} -- minimum signal-to-noise ratio for peak detection</strong><strong> (</strong><strong>default</strong> (<em>min_snr</em>) – {4})</p></li>
<li><p><strong>{float} -- minimum pixel value for peak detection</strong><strong> (</strong><strong>default</strong> (<em>threshold</em>) – {8})</p></li>
<li><p><strong>{int} -- minimum size of a peak in pixels</strong><strong> (</strong><strong>default</strong> (<em>min_pix_count</em>) – {2})</p></li>
<li><p><strong>{int} -- maximum size of a peak in pixels</strong><strong> (</strong><strong>default</strong> (<em>max_pix_count</em>) – {20})</p></li>
<li><p><strong>{int} -- radius for the estimation of the local background in pixels</strong><strong> (</strong><strong>default</strong> (<em>local_bg_radius</em>) – {3})</p></li>
<li><p><strong>{int} --  minimum resolution for a peak in pixels</strong><strong> (</strong><strong>default</strong> (<em>min_res</em>) – {0})</p></li>
<li><p><strong>{int} -- maximum resolution for a peak in pixels</strong><strong> (</strong><strong>default</strong> (<em>max_res</em>) – {500})</p></li>
</ul>
</dd>
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>[ndarray] – Vector of shape (3 * pkmax) + 1, or stack thereof (matrix). First {pkmax} entries are peak
x postions, then {pkmax} y positions, {pkmax} intensities, and finally the number of peaks.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.loop_over_stack">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">loop_over_stack</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">fun</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.loop_over_stack" title="Permalink to this definition">¶</a></dt>
<dd><p>Decorator to (sequentially) loop a 2D processing function over a stack.
Works on all functions with signature fun(imgs, <a href="#id11"><span class="problematic" id="id12">*</span></a>args, <a href="#id13"><span class="problematic" id="id14">**</span></a>kwargs), where
imgs is a 3D stack or a 2D single image.
If any of the positional/named arguments is an iterable of the same length
as the image stack, it is distributed over the function calls for each
image.</p>
<p>:param fun     : function to be decorated
:return         : decorated function</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.lorentz_fast">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">lorentz_fast</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">x_0</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">y_0</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">amp</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">scale</span><span class="o">=</span><span class="default_value">5.0</span></em>, <em class="sig-param"><span class="n">radius</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">limit</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">threads</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">verbose</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.lorentz_fast" title="Permalink to this definition">¶</a></dt>
<dd><p>Fast Lorentzian fit for finding beam center; especially suited for refinement after a reasonable estimate
(i.e. to a couple of pixels) has been made by another method such as truncated COM.
Compared to the other fits, it always assumes a shape parameter 2 (i.e. standard Lorentzian with asymptotic x^-2).
It can restrict the fit to only a small region around the initial value for the beam center, which massively speeds
up the function. Also, it auto-estimates the intial parameters somewhat reasonably if nothing else is given.
:param img: input image or image stack. If a stack is supplied, it is serially looped. Not accepting dask directly.
:param x_0: estimated x beam center. If None, is assumed to be in the center of the image.
:param y_0: analogous.
:param amp: estimated peak amplitude. If None, is set to the 99.99% percentile of img.
:param scale: peak HWHM estimate. Default: 5 pixels
:param radius: radius of a box around x_0, y_0 where the fit is actually done. If None, the entire image is used.
:param limit: If not None, the fit result is discarded if the found beam_center is further away than this value from</p>
<blockquote>
<div><p>the initial estimate.</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>threshold</strong> – pixel value threshold below which pixels are ignored. Best left at 0 usually.</p></li>
<li><p><strong>threads</strong> – if True, uses scipy.optimize.least_squares, which for larger arrays (radius more than around 15)
uses multithreaded function evaluation. Especially for radius &lt; 50, this may be slower than single-threaded.
In this case, best set to False</p></li>
<li><p><strong>verbose</strong> – if True, a message is printed on some occasions</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>numpy array of refined parameters [amp, x0, y0, scale]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.lorentz_fit">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">lorentz_fit</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">amp</span><span class="o">=</span><span class="default_value">1.0</span></em>, <em class="sig-param"><span class="n">x_0</span><span class="o">=</span><span class="default_value">0.0</span></em>, <em class="sig-param"><span class="n">y_0</span><span class="o">=</span><span class="default_value">0.0</span></em>, <em class="sig-param"><span class="n">scale</span><span class="o">=</span><span class="default_value">5.0</span></em>, <em class="sig-param"><span class="n">shape</span><span class="o">=</span><span class="default_value">2.0</span></em>, <em class="sig-param"><span class="n">threshold</span><span class="o">=</span><span class="default_value">0</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.lorentz_fit" title="Permalink to this definition">¶</a></dt>
<dd><p>Fits a Lorentz profile to find the centroid (x_0,y_0) of an image.
Build upon optimize.least_squares function  which is thread safe
Note: least.sq is not. Analytical Jacobian has been added.</p>
<p>:param amp      : normalisation of Lorentzian
:param x_0      : initial x position of centroid
:param y_0      : initial y position of centroid
:param scale    : scale of Lorentzian
:param shape    : shape of Lorentzian
:return         : output of least_squares</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.lorentz_fit_moving">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">lorentz_fit_moving</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">com</span></em>, <em class="sig-param"><span class="n">update_init</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">block_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">verbose</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">minimum_data</span><span class="o">=</span><span class="default_value">500</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.lorentz_fit_moving" title="Permalink to this definition">¶</a></dt>
<dd><p>Find the center positions and peak heights from Lorentz fits for a stack
of images, initializing each fit with the result of the previous one
within the stack.</p>
<p>:param img          : Image stack
:param com          : Center-of-mass positions as N-by-2 array
:param update_init  : If true, tries to initialize each fit with the</p>
<blockquote>
<div><p>: results of the previous one.</p>
</div></blockquote>
<p>:param block_id     : Optional, just used for status message.
:return             : Numpy array of the fit results</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.lorentz_fit_simple">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">lorentz_fit_simple</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">profile</span></em>, <em class="sig-param"><span class="n">bin_min</span><span class="o">=</span><span class="default_value">3</span></em>, <em class="sig-param"><span class="n">bin_max</span><span class="o">=</span><span class="default_value">40</span></em>, <em class="sig-param"><span class="n">amp</span><span class="o">=</span><span class="default_value">500.0</span></em>, <em class="sig-param"><span class="n">scale</span><span class="o">=</span><span class="default_value">5.0</span></em>, <em class="sig-param"><span class="n">shape</span><span class="o">=</span><span class="default_value">2.0</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.lorentz_fit_simple" title="Permalink to this definition">¶</a></dt>
<dd><p>Simplified Lorentz fit in the 1D-radial.</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.mean_clip">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">mean_clip</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">c</span></em>, <em class="sig-param"><span class="n">sigma</span><span class="o">=</span><span class="default_value">2.0</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.mean_clip" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Iteratively keeps only the values from the array that satisfies</dt><dd><p>0 &lt; c &lt; c_mean + sigma*std</p>
</dd>
</dl>
<p>and return the mean of the array. Assumes the
array contains positive entries,
if it does not or the array is empty returns -1</p>
<p>:param vector   : input vector of values.
:param sigma    : number of standard deviations away from the mean</p>
<blockquote>
<div><p>: that is allowed.</p>
</div></blockquote>
<p>:return c_mean  : mean of clipped values</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.radial_proj">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">radial_proj</code><span class="sig-paren">(</span><em class="sig-param">img: numpy.ndarray, x0: Optional[float] = None, y0: Optional[float] = None, my_func: Union[Callable[[numpy.ndarray], numpy.ndarray], List[Callable[[numpy.ndarray], numpy.ndarray]]] = &lt;function nanmean&gt;, min_size: int = 600, max_size: int = 850, filter_len: int = 1</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.radial_proj" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies the function to the azimuthal bins of the image around
the center (x0,y0) for each integer radius and returns the result
in a np.array of size max_size. Skips values that are set to -1 or nan.
:param img: input image
:param x0: x center of mass of image
:param y0: y center of mass of image
:param my_func: function to be applied to the bins, or list thereof
:param min_size: minimum length of output array
:param max_size: maximum length of output array
:param filter_len: kernel size of median filter applied after profile calculation.</p>
<blockquote>
<div><p>filter_len must be odd, and filtering is at the moment incompatible with multiple functions</p>
</div></blockquote>
<dl class="field-list simple">
<dt class="field-odd">Return result</dt>
<dd class="field-odd"><p>array of function returns on each radius.</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.remove_background">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">remove_background</code><span class="sig-paren">(</span><em class="sig-param">img, x0: Optional[float] = None, y0: Optional[float] = None, nPeaks: Optional[numpy.ndarray] = None, peakXPosRaw: Optional[numpy.ndarray] = None, peakYPosRaw: Optional[numpy.ndarray] = None, peak_radius=3, filter_len=5, rfunc: Callable[[numpy.ndarray], numpy.ndarray] = &lt;function nanmean&gt;, pxmask=None, truncate=False, offset=0</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.remove_background" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.stack_nested">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">stack_nested</code><span class="sig-paren">(</span><em class="sig-param">data_list</em>, <em class="sig-param">fun=&lt;function stack&gt;</em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.stack_nested" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.proc2d.strip_img">
<code class="sig-prename descclassname">diffractem.proc2d.</code><code class="sig-name descname">strip_img</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">img</span></em>, <em class="sig-param"><span class="n">x0</span></em>, <em class="sig-param"><span class="n">y0</span></em>, <em class="sig-param"><span class="n">prof</span><span class="p">:</span> <span class="n">numpy.ndarray</span></em>, <em class="sig-param"><span class="n">pxmask</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>numpy.ndarray<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">truncate</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">offset</span><span class="o">=</span><span class="default_value">0</span></em>, <em class="sig-param"><span class="n">keep_edge_offset</span><span class="o">=</span><span class="default_value">False</span></em>, <em class="sig-param"><span class="n">replaceval</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>float<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">interp</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">dtype</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc2d.strip_img" title="Permalink to this definition">¶</a></dt>
<dd><p>Given an image, center coordinate(x0,y0) and a radial profile, removes the
radial profile from the image.</p>
</dd></dl>

</div>
<div class="section" id="module-diffractem.proc_peaks">
<span id="diffractem-proc-peaks-module"></span><h2>diffractem.proc_peaks module<a class="headerlink" href="#module-diffractem.proc_peaks" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.proc_peaks.center_friedel">
<code class="sig-prename descclassname">diffractem.proc_peaks.</code><code class="sig-name descname">center_friedel</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">peaks</span><span class="p">:</span> <span class="n">pandas.core.frame.DataFrame</span></em>, <em class="sig-param"><span class="n">shots</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>pandas.core.frame.DataFrame<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">p0</span><span class="o">=</span><span class="default_value">778, 308</span></em>, <em class="sig-param"><span class="n">colnames</span><span class="o">=</span><span class="default_value">'fs/px', 'ss/px'</span></em>, <em class="sig-param"><span class="n">sigma</span><span class="o">=</span><span class="default_value">2</span></em>, <em class="sig-param"><span class="n">minpeaks</span><span class="o">=</span><span class="default_value">4</span></em>, <em class="sig-param"><span class="n">maxres</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>float<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.proc_peaks.center_friedel" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>[Center refinement of diffraction patterns from a list of peaks, assuming the presence</dt><dd><p>of a significant number of Friedel mates.]</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>{</strong><strong>[</strong><strong>pd.DataFrame</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>peaks list for entire data set</strong><strong>, </strong><strong>as returned by StreamParser</strong><strong>]</strong> (<em>peaks</em>) – </p>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{</strong><strong>[</strong><strong>pd.DataFrame</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>shot list of data set</strong><strong>, </strong><strong>optional</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<a class="reference internal" href="#diffractem.dataset.Dataset.shots" title="diffractem.dataset.Dataset.shots"><em>shots</em></a>) – {None})</p></li>
<li><p><strong>{tuple} --</strong><strong> [</strong><strong>starting position for center search</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>p0</em>) – {(778, 308)})</p></li>
<li><p><strong>{tuple} --</strong><strong> [</strong><strong>column names for x and y coordinate</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>colnames</em>) – {(‘fs/px’, ‘ss/px’)})</p></li>
<li><p><strong>{int} --</strong><strong> [</strong><strong>peak rms radius</strong> (<em>sigma</em>) – {2})</p></li>
<li><p><strong>{int} --</strong><strong> [</strong><strong>minimum peak number to try matching</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>minpeaks</em>) – {4})</p></li>
<li><p><strong>{int} --</strong><strong> [</strong><strong>maximum radius of peaks to still be considered</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>maxres</em>) – {None})</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="module-diffractem.stream_parser">
<span id="diffractem-stream-parser-module"></span><h2>diffractem.stream_parser module<a class="headerlink" href="#module-diffractem.stream_parser" title="Permalink to this headline">¶</a></h2>
<dl class="py class">
<dt id="diffractem.stream_parser.StreamParser">
<em class="property">class </em><code class="sig-prename descclassname">diffractem.stream_parser.</code><code class="sig-name descname">StreamParser</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">parse_now</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">serial_offset</span><span class="o">=</span><span class="default_value">- 1</span></em>, <em class="sig-param"><span class="n">new_folder</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.StreamParser" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.cell">
<em class="property">property </em><code class="sig-name descname">cell</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.cell" title="Permalink to this definition">¶</a></dt>
<dd><p>cell section as dictionary</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>return</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.change_path">
<code class="sig-name descname">change_path</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">new_folder</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">old_pattern</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">new_pattern</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.StreamParser.change_path" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.files">
<em class="property">property </em><code class="sig-name descname">files</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.files" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.geometry">
<em class="property">property </em><code class="sig-name descname">geometry</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.geometry" title="Permalink to this definition">¶</a></dt>
<dd><p>geometry section as dictionary</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>return</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.get_cxi_format">
<code class="sig-name descname">get_cxi_format</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">what</span><span class="o">=</span><span class="default_value">'peaks'</span></em>, <em class="sig-param"><span class="n">shots</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">half_pixel_shift</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.StreamParser.get_cxi_format" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.indexed">
<em class="property">property </em><code class="sig-name descname">indexed</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.indexed" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.input_file">
<em class="property">property </em><code class="sig-name descname">input_file</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.input_file" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.options">
<em class="property">property </em><code class="sig-name descname">options</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.options" title="Permalink to this definition">¶</a></dt>
<dd><p>crystfel call options (ONLY – ones) as dict</p>
<dl class="field-list simple">
<dt class="field-odd">Type</dt>
<dd class="field-odd"><p>return</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.parse">
<code class="sig-name descname">parse</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">new_folder</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.StreamParser.parse" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.peaks">
<em class="property">property </em><code class="sig-name descname">peaks</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.peaks" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.shots">
<em class="property">property </em><code class="sig-name descname">shots</code><a class="headerlink" href="#diffractem.stream_parser.StreamParser.shots" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="diffractem.stream_parser.StreamParser.write">
<code class="sig-name descname">write</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">filename</span></em>, <em class="sig-param"><span class="n">include_peaks</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">include_indexed</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">include_geom</span><span class="o">=</span><span class="default_value">True</span></em>, <em class="sig-param"><span class="n">include_cell</span><span class="o">=</span><span class="default_value">True</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.StreamParser.write" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py function">
<dt id="diffractem.stream_parser.augment_stream">
<code class="sig-prename descclassname">diffractem.stream_parser.</code><code class="sig-name descname">augment_stream</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">streamname</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">outfile</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">new_fields</span><span class="p">:</span> <span class="n">Union<span class="p">[</span>pandas.core.frame.DataFrame<span class="p">, </span>dict<span class="p">]</span></span></em>, <em class="sig-param"><span class="n">where</span><span class="p">:</span> <span class="n">str</span> <span class="o">=</span> <span class="default_value">'chunk'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.augment_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>IDEA: add new fields to stream headers, which can then be used for chopping or filtering.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{str} --</strong><strong> [</strong><strong>description</strong><strong>]</strong> (<em>streamname</em>) – </p></li>
<li><p><strong>{Union</strong><strong>[</strong><strong>pd.DataFrame</strong><strong>, </strong><strong>dict</strong><strong>]</strong><strong>} --</strong><strong> [</strong><strong>description</strong><strong>]</strong> (<em>new_fields</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Raises</dt>
<dd class="field-even"><p><strong>NotImplementedError</strong> – [description]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.stream_parser.chop_stream">
<code class="sig-prename descclassname">diffractem.stream_parser.</code><code class="sig-name descname">chop_stream</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">streamname</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">id_list</span><span class="p">:</span> <span class="n">list</span></em>, <em class="sig-param"><span class="n">id_field</span><span class="o">=</span><span class="default_value">'hdf5/%/shots/frame'</span></em>, <em class="sig-param"><span class="n">id_appendix</span><span class="o">=</span><span class="default_value">'frame'</span></em>, <em class="sig-param"><span class="n">fn_contains</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.chop_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>Chops a stream file into sub-streams containing only shots with a specific value of
a defined field, which must be in the chunk header. Useful e.g. for chopping into aggregation
frames.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{str} --</strong><strong> [</strong><strong>Stream file name</strong><strong>]</strong> (<em>streamname</em>) – </p></li>
<li><p><strong>{str} --</strong><strong> [</strong><strong>List of values of the ID variable which you want to have in the final files.</strong><strong>]</strong> (<em>id_list</em>) – </p></li>
</ul>
</dd>
<dt class="field-even">Keyword Arguments</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>{str} --</strong><strong> [</strong><strong>Field in chunk data to select by</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>id_field</em>) – {‘hdf5/%/shots/frame’})</p></li>
<li><p><strong>{str} --</strong><strong> [</strong><strong>file appendix specifying the ID</strong><strong>] </strong><strong>(</strong><strong>default</strong> (<em>id_appendix</em>) – {‘frame’})</p></li>
</ul>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><strong>RuntimeError</strong> – [weirdness in the stream found]</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.stream_parser.parse_str_val">
<code class="sig-prename descclassname">diffractem.stream_parser.</code><code class="sig-name descname">parse_str_val</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input</span><span class="p">:</span> <span class="n">str</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.stream_parser.parse_str_val" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-diffractem.tools">
<span id="diffractem-tools-module"></span><h2>diffractem.tools module<a class="headerlink" href="#module-diffractem.tools" title="Permalink to this headline">¶</a></h2>
<dl class="py function">
<dt id="diffractem.tools.call_indexamajig">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">call_indexamajig</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input</span></em>, <em class="sig-param"><span class="n">geometry</span></em>, <em class="sig-param"><span class="n">output</span><span class="o">=</span><span class="default_value">'im_out.stream'</span></em>, <em class="sig-param"><span class="n">cell</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>str<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">im_params</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>dict<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">index_params</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>dict<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">procs</span><span class="p">:</span> <span class="n">Optional<span class="p">[</span>int<span class="p">]</span></span> <span class="o">=</span> <span class="default_value">None</span></em>, <em class="sig-param"><span class="n">exc</span><span class="o">=</span><span class="default_value">'indexamajig'</span></em>, <em class="sig-param"><span class="n">copy_fields</span><span class="p">:</span> <span class="n">list</span> <span class="o">=</span> <span class="default_value">()</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.call_indexamajig" title="Permalink to this definition">¶</a></dt>
<dd><p>Generates an indexamajig command from a dictionary of indexamajig parameters, a exc dictionary of files names and core number, and an indexer dictionary</p>
<p>e.g.</p>
<dl class="simple">
<dt>im_params = {‘min-res’: 10, ‘max-res’: 300, ‘min-peaks’: 0,</dt><dd><p>‘int-radius’: ‘3,4,6’, ‘min-snr’: 4, ‘threshold’: 0,
‘min-pix-count’: 2, ‘max-pix-count’:100,
‘peaks’: ‘peakfinder8’, ‘fix-profile-radius’: 0.1e9,
‘indexing’: ‘none’, ‘push-res’: 2, ‘no-cell-combinations’: None,
‘integration’: ‘rings-rescut’,’no-refine’: None,
‘no-non-hits-in-stream’: None, ‘no-retry’: None, ‘no-check-peaks’: None} #’local-bg-radius’: False,</p>
</dd>
<dt>index_params ={‘pinkIndexer-considered-peaks-count’: 4,</dt><dd><p>‘pinkIndexer-angle-resolution’: 4,
‘pinkIndexer-refinement-type’: 0,
‘pinkIndexer-thread-count’: 1,
‘pinkIndexer-tolerance’: 0.10}</p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.call_partialator">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">call_partialator</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input</span></em>, <em class="sig-param"><span class="n">symmetry</span></em>, <em class="sig-param"><span class="n">output</span><span class="o">=</span><span class="default_value">'im_out.stream'</span></em>, <em class="sig-param"><span class="n">model</span><span class="o">=</span><span class="default_value">'unity'</span></em>, <em class="sig-param"><span class="n">iterations</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">opts</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">procs</span><span class="o">=</span><span class="default_value">40</span></em>, <em class="sig-param"><span class="n">exc</span><span class="o">=</span><span class="default_value">'partialator'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.call_partialator" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.tools.chop_stream">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">chop_stream</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">streamfile</span><span class="p">:</span> <span class="n">str</span></em>, <em class="sig-param"><span class="n">shots</span><span class="p">:</span> <span class="n">pandas.core.frame.DataFrame</span></em>, <em class="sig-param"><span class="n">query</span><span class="o">=</span><span class="default_value">'frame == 1'</span></em>, <em class="sig-param"><span class="n">postfix</span><span class="o">=</span><span class="default_value">'fr1'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.chop_stream" title="Permalink to this definition">¶</a></dt>
<dd><p>Carve shots with a given frame number from a stream file</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>{str} --</strong><strong> [</strong><strong>stream file to open</strong><strong>]</strong> (<em>streamfile</em>) – </p></li>
<li><p><strong>{int} --</strong><strong> [</strong><strong>frame number to extract</strong><strong>]</strong> (<em>frame</em>) – </p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.dataframe_hash">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">dataframe_hash</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">df</span><span class="p">:</span> <span class="n">pandas.core.frame.DataFrame</span></em>, <em class="sig-param"><span class="n">signed</span><span class="p">:</span> <span class="n">bool</span> <span class="o">=</span> <span class="default_value">True</span></em><span class="sig-paren">)</span> &#x2192; pandas.core.series.Series<a class="headerlink" href="#diffractem.tools.dataframe_hash" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate int32 (or uint32 if signed=False) hashes from a pandas data frame and return as a pandas Series.
The hash is generated with md5 from a whitespace-delimited string representation from each data frame row,
such as e.g.:
“data/file_a.h5 entry//0” (so similar to CrystFEL’s list syntax).</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.dict2file">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">dict2file</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">file_name</span></em>, <em class="sig-param"><span class="n">file_dic</span></em>, <em class="sig-param"><span class="n">header</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.dict2file" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.tools.insert_init">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">insert_init</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">shots</span></em>, <em class="sig-param"><span class="n">predist</span><span class="o">=</span><span class="default_value">100</span></em>, <em class="sig-param"><span class="n">dxmax</span><span class="o">=</span><span class="default_value">200</span></em>, <em class="sig-param"><span class="n">xcol</span><span class="o">=</span><span class="default_value">'pos_x'</span></em>, <em class="sig-param"><span class="n">initpoints</span><span class="o">=</span><span class="default_value">1</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.insert_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Insert initialization frames into scan list, to mitigate hysteresis and beam tilt streaking when scanning along x.
Works by inserting a single frame each time the x coordinate decreases (beam moves left) or increases by more
than dxmax (beam moves too quickly). The initialization frame is taken to the left of the position after the jump by
predist pixels. Its crystal_id and frame columns are set to -1.
:param shots: initial scan list. Note: if you want to have multiple frames, you should always first run set_frames
:param predist: distance of the initialization shot from the actual image along x
:param dxmax: maximum allowed jump size (in pixels) to the right.
:param xcol: name of x position column
:param initpoints: number of initialization points added
:return: scan list with inserted additional points</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.make_command">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">make_command</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">program</span></em>, <em class="sig-param"><span class="n">arguments</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">params</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">opts</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.make_command" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.tools.make_geometry">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">make_geometry</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">parameters</span></em>, <em class="sig-param"><span class="n">file_name</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.make_geometry" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py function">
<dt id="diffractem.tools.make_reference">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">make_reference</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">reference_filename</span></em>, <em class="sig-param"><span class="n">output_base_fn</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">ref_smooth_range</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">thr_rel_var</span><span class="o">=</span><span class="default_value">0.2</span></em>, <em class="sig-param"><span class="n">thr_mean</span><span class="o">=</span><span class="default_value">0.2</span></em>, <em class="sig-param"><span class="n">gap_factor</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">save_stat_imgs</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.make_reference" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculates reference data for dead pixels AND flatfield (=’gain’=’sensitivity’). Returns the boolean dead pixel
array, and a floating-point flatfield (normalized to median intensity 1).</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.quantize_y_scan">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">quantize_y_scan</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">shots</span></em>, <em class="sig-param"><span class="n">maxdev</span><span class="o">=</span><span class="default_value">1</span></em>, <em class="sig-param"><span class="n">min_rows</span><span class="o">=</span><span class="default_value">30</span></em>, <em class="sig-param"><span class="n">max_rows</span><span class="o">=</span><span class="default_value">500</span></em>, <em class="sig-param"><span class="n">inc</span><span class="o">=</span><span class="default_value">10</span></em>, <em class="sig-param"><span class="n">ycol</span><span class="o">=</span><span class="default_value">'pos_y'</span></em>, <em class="sig-param"><span class="n">ycol_to</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">xcol</span><span class="o">=</span><span class="default_value">'pos_x'</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.quantize_y_scan" title="Permalink to this definition">¶</a></dt>
<dd><p>Reads a DataFrame containing scan points (in columns xcol and ycol), and quantizes the y positions (scan rows) to
a reduced number of discrete values, keeping the deviation of the quantized rows to the actual y positions
below a specified value. The quantized y positions are determined by K-means clustering and unequally spaced.
:param shots: initial scan list
:param maxdev: maximum mean standard deviation of row positions from point y coordinates in pixels
:param min_rows: minimum number of quantized scan rows. Don’t set to something unreasonably low, otherwise takes long
:param max_rows: maximum number of quantized scan rows
:param inc: step size for determining row number
:param ycol: column of initial y positions in shots
:param ycol_to: column of final y row positions in return data frame. If None, overwrite initial y positions
:param xcol: column of x positions. Required for final sorting.
:return: scan list with quantized y (row) (positions)</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.set_frames">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">set_frames</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">shots</span></em>, <em class="sig-param"><span class="n">frames</span><span class="o">=</span><span class="default_value">1</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.set_frames" title="Permalink to this definition">¶</a></dt>
<dd><p>Adds additional frames to each scan position by repeating each line, and adding/setting a frame column
:param shots: initial scan list. Each scan points must have a unique index, otherwise behavior may be funny.
:param frames: number of frames per scan position
:return: scan list with many frames per position</p>
</dd></dl>

<dl class="py function">
<dt id="diffractem.tools.strip_file_path">
<code class="sig-prename descclassname">diffractem.tools.</code><code class="sig-name descname">strip_file_path</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">df</span><span class="p">:</span> <span class="n">pandas.core.frame.DataFrame</span></em>, <em class="sig-param"><span class="n">add_folder</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="headerlink" href="#diffractem.tools.strip_file_path" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
<div class="section" id="module-diffractem">
<span id="module-contents"></span><h2>Module contents<a class="headerlink" href="#module-diffractem" title="Permalink to this headline">¶</a></h2>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">diffractem</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Robert Buecker.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/diffractem.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>