

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Serial diffraction data preprocessing using diffractem &mdash; diffractem  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/jupyter-sphinx.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Merging of serial data sets" href="merging.html" />
    <link rel="prev" title="Indexing using PinkIndexer" href="indexing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> diffractem
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../notebooks.html">Tutorial notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="indexing.html">Indexing using PinkIndexer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Serial diffraction data preprocessing using <em>diffractem</em></a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Dataset-initialization">Dataset initialization</a></li>
<li class="toctree-l3"><a class="reference internal" href="#A-good-time-to-optimize-the-peak-finder">A good time to optimize the peak finder</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Centering-refinement">Centering refinement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Centering-check">Centering check</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Ready-for-indexing,-Preparation-of-sets-for-integration">Ready for indexing, Preparation of sets for integration</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#Apply-pre-processing-to-single-frames">Apply pre-processing to single frames</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Background-subtraction">Background subtraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Cumulation">Cumulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Done!">Done!</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="merging.html">Merging of serial data sets</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dataset.html">The Dataset object</a></li>
<li class="toctree-l1"><a class="reference internal" href="../file_format.html">Diffractem NeXus files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pre_processing.html">Preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crystfel.html">CrystFEL integration</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">diffractem</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../notebooks.html">Tutorial notebooks</a> &raquo;</li>
        
      <li>Serial diffraction data preprocessing using <em>diffractem</em></li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/notebooks/preprocessing.nblink.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="kn">import</span> <span class="nn">hdf5plugin</span> <span class="c1"># required to access LZ4-encoded HDF5 data sets</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">diffractem</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">tools</span><span class="p">,</span> <span class="n">proc_peaks</span><span class="p">,</span> <span class="n">version</span>
<span class="kn">from</span> <span class="nn">diffractem.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">diffractem.stream_parser</span> <span class="kn">import</span> <span class="n">StreamParser</span>
<span class="kn">from</span> <span class="nn">diffractem</span> <span class="kn">import</span> <span class="n">pre_process</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">opts</span> <span class="o">=</span> <span class="n">pre_process</span><span class="o">.</span><span class="n">PreProcOpts</span><span class="p">(</span><span class="s1">&#39;preproc.yaml&#39;</span><span class="p">)</span>
<span class="n">cfver</span> <span class="o">=</span> <span class="o">!{</span>opts.im_exc<span class="o">}</span> -v
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running on diffractem:&#39;</span><span class="p">,</span> <span class="n">version</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Running on&#39;</span><span class="p">,</span> <span class="n">cfver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Current path is:&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Running on diffractem: v0.2.1-52-g0d34dce
Running on CrystFEL: 0.8.0+f9101682
Current path is: /nas/processing/serialed/GV/publication
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Executor function for pre-processing steps.</span>
<span class="c1"># Change to adapt to your favorite parallelization scheme.</span>
<span class="c1"># This one is good if you have as many or more HDF5 files</span>
<span class="c1"># than CPU cores in your system.</span>
<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">files</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">exc</span><span class="p">,</span> <span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;single-threaded&#39;</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">opts</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">out</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="Serial-diffraction-data-preprocessing-using-diffractem">
<h1>Serial diffraction data preprocessing using <em>diffractem</em><a class="headerlink" href="#Serial-diffraction-data-preprocessing-using-diffractem" title="Permalink to this headline">¶</a></h1>
<p>This notebook requires the diffractem package available from: <a class="reference external" href="https://github.com/robertbuecker/diffractem">https://github.com/robertbuecker/diffractem</a> It can be installed using pip: <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">diffractem</span></code>.</p>
<p>Furthermore, a working installation of CrystFEL is required, available from: <a class="reference external" href="http://www.desy.de/~twhite/crystfel/">http://www.desy.de/~twhite/crystfel/</a></p>
<p>Get example raw data from: <a class="reference external" href="https://dx.doi.org/10.17617/3.2j">https://dx.doi.org/10.17617/3.2j</a></p>
<p>First, we have to make a list of raw files. <code class="docutils literal notranslate"><span class="pre">io.expand_files</span></code> can eiter using a list file, or explicit paths (including wildcards).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">raw_files</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">expand_files</span><span class="p">(</span><span class="s1">&#39;data/*.nxs&#39;</span><span class="p">)[:</span><span class="mi">8</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Have </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">raw_files</span><span class="p">)</span><span class="si">}</span><span class="s1"> raw files. Have fun pre-processing!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Have 8 raw files. Have fun pre-processing!
</pre></div></div>
</div>
<div class="section" id="Dataset-initialization">
<h2>Dataset initialization<a class="headerlink" href="#Dataset-initialization" title="Permalink to this headline">¶</a></h2>
<p>pre_process.from_raw does the following: * apply flat-field, saturation, and dead-pixel correction * find the beam center using center of mass and fit of central peak * shift the images accordingly * write everything into new, renamed files</p>
<p>don’t be irritated by occasional <code class="docutils literal notranslate"><span class="pre">RuntimeWarning</span></code>s from <code class="docutils literal notranslate"><span class="pre">scipy.optimize</span></code>.</p>
<p>The following options have an influence: reference, pxmask, correct_saturation, dead_time, shutter_time, float, cam_length, com_threshold, com_xrng, lorentz_radius, lorentz_maxshift, xsize, ysize, r_adf1, r_adf2, select_query, agg_query, aggregate, scratch_dir, proc_dir, rechunk</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span><span class="o">.</span><span class="n">load</span><span class="p">()</span> <span class="c1"># re-load option file</span>
<span class="n">initial</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pre_process</span><span class="o">.</span><span class="n">from_raw</span><span class="p">,</span> <span class="n">raw_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
[20:58:54.395474 - GV_S11_008_00000.nxs - from_raw]  1866 raw, 178 aggregated/selected.
[20:58:54.633333 - GV_S11_009_00000.nxs - from_raw]  2197 raw, 211 aggregated/selected.
[20:58:55.497641 - GV_S11_004_00000.nxs - from_raw]  3616 raw, 346 aggregated/selected.
[20:58:55.530468 - GV_S11_001_00000.nxs - from_raw]  3833 raw, 367 aggregated/selected.
[20:58:55.795339 - GV_S11_003_00000.nxs - from_raw]  4197 raw, 404 aggregated/selected.
[20:58:55.870685 - GV_S11_007_00000.nxs - from_raw]  4186 raw, 400 aggregated/selected.
[20:58:57.397478 - GV_S11_005_00000.nxs - from_raw]  6136 raw, 588 aggregated/selected.
[20:58:57.447048 - GV_S11_002_00000.nxs - from_raw]  6108 raw, 588 aggregated/selected.
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda/envs/serialed/lib/python3.7/site-packages/scipy/optimize/minpack.py:449: RuntimeWarning: Number of calls to function has reached maxfev = 500.
  warnings.warn(errors[info][0], RuntimeWarning)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[21:01:11.064499 - GV_S11_008_00000.nxs - from_raw]  Finished first centering 178 shots after 138.44707894325256 seconds
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opt/anaconda/envs/serialed/lib/python3.7/site-packages/scipy/optimize/minpack.py:449: RuntimeWarning: Number of calls to function has reached maxfev = 500.
  warnings.warn(errors[info][0], RuntimeWarning)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[21:01:14.132211 - GV_S11_009_00000.nxs - from_raw]  Finished first centering 211 shots after 141.51425743103027 seconds
[21:02:46.544648 - GV_S11_004_00000.nxs - from_raw]  Finished first centering 346 shots after 233.92890405654907 seconds
[21:03:01.116148 - GV_S11_003_00000.nxs - from_raw]  Finished first centering 404 shots after 248.50097346305847 seconds
[21:03:06.356061 - GV_S11_007_00000.nxs - from_raw]  Finished first centering 400 shots after 253.7390420436859 seconds
[21:03:09.430620 - GV_S11_001_00000.nxs - from_raw]  Finished first centering 367 shots after 256.81595849990845 seconds
[21:04:09.713914 - GV_S11_005_00000.nxs - from_raw]  Finished first centering 588 shots after 317.0971086025238 seconds
[21:04:23.816727 - GV_S11_002_00000.nxs - from_raw]  Finished first centering 588 shots after 331.2015686035156 seconds
</pre></div></div>
</div>
</div>
<div class="section" id="A-good-time-to-optimize-the-peak-finder">
<h2>A good time to optimize the peak finder<a class="headerlink" href="#A-good-time-to-optimize-the-peak-finder" title="Permalink to this headline">¶</a></h2>
<p>run this on a data sub-set, and look at the output stream: <code class="docutils literal notranslate"><span class="pre">edview.py</span> <span class="pre">agg_peaks.stream</span> <span class="pre">--internal</span></code></p>
<p>Then, if required, tweak the <code class="docutils literal notranslate"><span class="pre">peak_search_params</span></code> settings in <code class="docutils literal notranslate"><span class="pre">preproc.yaml</span></code> until it looks something like:</p>
<p><img alt="Nice peak finder result" src="notebooks/doc/found_peaks.png" /></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="c1"># we don&#39;t want to read the peaks into this workspace, so we set parse=False.</span>
<span class="c1"># Don&#39;t be irritated by &#39;waitpid() failed.&#39; messages, that&#39;s ok.</span>
<span class="n">pre_process</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">initial</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span> <span class="n">stream_out</span><span class="o">=</span><span class="s1">&#39;agg_peaks.stream&#39;</span><span class="p">,</span> <span class="n">parse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Indexing/integration disabled.
1571 images processed, 1421 hits (90.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 314.2 images/sec.
Waiting for the last patterns to be processed...
Final: 3082 images processed, 2769 hits (89.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;agg_peaks.stream&#39;
</pre></div></div>
</div>
<div class="section" id="Centering-refinement">
<h3>Centering refinement<a class="headerlink" href="#Centering-refinement" title="Permalink to this headline">¶</a></h3>
<p>…based on matching of Friedel pairs present in a single image at low resolution (flat Ewald sphere of electrons!). Make sure that the peak finder works nicely <em>before</em> running the refinement.</p>
<p>After calculating and storing the re-centered stack, the peak finding is automatically invoked, and the peaks are stored in the HDF5 files depending on how <code class="docutils literal notranslate"><span class="pre">peaks_cxi</span></code> and <code class="docutils literal notranslate"><span class="pre">peaks_nexus</span></code> are set in the options file. The former makes more sense, if you want to transfer the found peaks to other files later.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span> <span class="o">=</span> <span class="n">pre_process</span><span class="o">.</span><span class="n">PreProcOpts</span><span class="p">(</span><span class="s1">&#39;preproc.yaml&#39;</span><span class="p">)</span>
<span class="n">refined</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pre_process</span><span class="o">.</span><span class="n">refine_center</span><span class="p">,</span> <span class="n">initial</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Indexing/integration disabled.
205 images processed, 175 hits (85.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 41.0 images/sec.
Waiting for the last patterns to be processed...
353 images processed, 309 hits (87.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 29.6 images/sec.
Final: 367 images processed, 321 hits (87.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
0 images processed, 0 hits (-nan%), 0 indexable (-nan% of hits, -nan% overall), 0 crystals, 0.0 images/sec.
32 images processed, 27 hits (84.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 6.4 images/sec.
102 images processed, 94 hits (92.2%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 14.0 images/sec.
Waiting for the last patterns to be processed...
190 images processed, 178 hits (93.7%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 17.6 images/sec.
Final: 211 images processed, 197 hits (93.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.
Indexing/integration disabled.
67 images processed, 66 hits (98.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 13.4 images/sec.
194 images processed, 187 hits (96.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 25.4 images/sec.
Waiting for the last patterns to be processed...
339 images processed, 313 hits (92.3%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 29.0 images/sec.
Final: 346 images processed, 320 hits (92.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.
Indexing/integration disabled.
0 images processed, 0 hits (-nan%), 0 indexable (-nan% of hits, -nan% overall), 0 crystals, 0.0 images/sec.
33 images processed, 31 hits (93.9%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 6.6 images/sec.
94 images processed, 89 hits (94.7%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 12.2 images/sec.
Waiting for the last patterns to be processed...
178 images processed, 171 hits (96.1%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 16.8 images/sec.
Final: 178 images processed, 171 hits (96.1%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.



Indexing/integration disabled.
30 images processed, 28 hits (93.3%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 6.0 images/sec.
128 images processed, 120 hits (93.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 19.6 images/sec.
283 images processed, 262 hits (92.6%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 31.0 images/sec.
Waiting for the last patterns to be processed...
393 images processed, 361 hits (91.9%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 22.0 images/sec.
Final: 404 images processed, 371 hits (91.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.
Indexing/integration disabled.
0 images processed, 0 hits (-nan%), 0 indexable (-nan% of hits, -nan% overall), 0 crystals, 0.0 images/sec.
11 images processed, 10 hits (90.9%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 2.2 images/sec.
69 images processed, 58 hits (84.1%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 11.6 images/sec.
162 images processed, 128 hits (79.0%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 18.6 images/sec.
283 images processed, 224 hits (79.2%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 24.2 images/sec.
Waiting for the last patterns to be processed...
Final: 400 images processed, 315 hits (78.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.


Indexing/integration disabled.
0 images processed, 0 hits (-nan%), 0 indexable (-nan% of hits, -nan% overall), 0 crystals, 0.0 images/sec.
19 images processed, 18 hits (94.7%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 3.8 images/sec.
90 images processed, 78 hits (86.7%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 14.2 images/sec.
185 images processed, 161 hits (87.0%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 19.0 images/sec.
293 images processed, 259 hits (88.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 21.6 images/sec.
417 images processed, 365 hits (87.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 24.8 images/sec.
Waiting for the last patterns to be processed...
567 images processed, 505 hits (89.1%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 30.0 images/sec.
Final: 588 images processed, 526 hits (89.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
0 images processed, 0 hits (-nan%), 0 indexable (-nan% of hits, -nan% overall), 0 crystals, 0.0 images/sec.
5 images processed, 5 hits (100.0%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 1.0 images/sec.
54 images processed, 47 hits (87.0%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 9.8 images/sec.
140 images processed, 126 hits (90.0%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 17.2 images/sec.
263 images processed, 243 hits (92.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 24.6 images/sec.
396 images processed, 366 hits (92.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals, 26.6 images/sec.
Waiting for the last patterns to be processed...
Final: 588 images processed, 548 hits (93.2%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

[21:05:14.743584 - GV_S11_008_00000_agg.h5 - refine_center]  89.8876% of shots refined.
 Shift standard deviation: [0.8774898  1.13952984]
 Average shift: [-0.23044018  0.42745885]

[21:05:14.971053 - GV_S11_009_00000_agg.h5 - refine_center]  89.5735% of shots refined.
 Shift standard deviation: [0.57852068 0.85459127]
 Average shift: [0.00141827 0.10994113]

[&#39;proc_data/GV_S11_008_00000_agg_refined.h5&#39;]
[&#39;proc_data/GV_S11_009_00000_agg_refined.h5&#39;]
[21:05:15.458137 - GV_S11_007_00000_agg.h5 - refine_center]  46% of shots refined.
 Shift standard deviation: [0.50401083 0.51571384]
 Average shift: [ 0.01323759 -0.01316589]

[21:05:15.578087 - GV_S11_004_00000_agg.h5 - refine_center]  80.0578% of shots refined.
 Shift standard deviation: [0.64185621 0.59364946]
 Average shift: [0.03120839 0.16869584]

[21:05:15.631651 - GV_S11_001_00000_agg.h5 - refine_center]  81.4714% of shots refined.
 Shift standard deviation: [0.72122758 0.67488768]
 Average shift: [-0.04551799  0.18973828]

[&#39;proc_data/GV_S11_007_00000_agg_refined.h5&#39;]
[21:05:15.704200 - GV_S11_003_00000_agg.h5 - refine_center]  88.6139% of shots refined.
 Shift standard deviation: [0.80403269 0.84466481]
 Average shift: [0.11070731 0.03663909]

[&#39;proc_data/GV_S11_004_00000_agg_refined.h5&#39;]
[&#39;proc_data/GV_S11_001_00000_agg_refined.h5&#39;]
[&#39;proc_data/GV_S11_003_00000_agg_refined.h5&#39;]
[21:05:16.240428 - GV_S11_002_00000_agg.h5 - refine_center]  77.7211% of shots refined.
 Shift standard deviation: [0.82963867 0.75006635]
 Average shift: [0.1869678  0.03146149]

[21:05:16.338592 - GV_S11_005_00000_agg.h5 - refine_center]  90.4762% of shots refined.
 Shift standard deviation: [0.72738779 0.76468732]
 Average shift: [0.11293863 0.18960904]

[&#39;proc_data/GV_S11_002_00000_agg_refined.h5&#39;]
[&#39;proc_data/GV_S11_005_00000_agg_refined.h5&#39;]
Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 178 images processed, 171 hits (96.1%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 211 images processed, 197 hits (93.4%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 367 images processed, 321 hits (87.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 346 images processed, 320 hits (92.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 404 images processed, 371 hits (91.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 400 images processed, 315 hits (78.8%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
Final: 588 images processed, 548 hits (93.2%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

Indexing/integration disabled.
Waiting for the last patterns to be processed...
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
waitpid() failed.
Final: 588 images processed, 526 hits (89.5%), 0 indexable (0.0% of hits, 0.0% overall), 0 crystals.

</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Centering-check">
<h2>Centering check<a class="headerlink" href="#Centering-check" title="Permalink to this headline">¶</a></h2>
<p>…to see if the centering worked as intended, and if everything is ready for indexing. Consider running it only for a sub-set by slicing <code class="docutils literal notranslate"><span class="pre">initial</span></code> and <code class="docutils literal notranslate"><span class="pre">refined</span></code> in the first two lines. In the first cell, you will get a histogram of the change in center along x and y.</p>
<p>The second cell picks 4 random patterns, and shows the right half of them three times: (left) the pattern, (center) the pattern subtracted from itself rotated by 180 degrees before refinement, (right) the same after refinement. Bad centering will cause a “dipole” shape of mated Bragg peaks. You should see, that the Bragg peaks cancel each other nicely at the end (right panel). See green arrows below. It should look something like this:</p>
<p><img alt="Centering" src="notebooks/doc/centering.png" /></p>
<p>Don’t be irritated if the central beam looks messier on the refined difference image, that’s ok.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ds_original</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">initial</span><span class="p">[:])</span>
<span class="n">ds_refined</span> <span class="o">=</span> <span class="n">Dataset</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">refined</span><span class="p">[:])</span>

<span class="k">with</span> <span class="n">ds_original</span><span class="o">.</span><span class="n">Stacks</span><span class="p">()</span> <span class="k">as</span> <span class="n">stk_original</span><span class="p">,</span> <span class="n">ds_refined</span><span class="o">.</span><span class="n">Stacks</span><span class="p">()</span> <span class="k">as</span> <span class="n">stk_refined</span><span class="p">:</span>
    <span class="n">shifts</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds_refined</span><span class="o">.</span><span class="n">beam_center</span> <span class="o">-</span> <span class="n">ds_original</span><span class="o">.</span><span class="n">beam_center</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="n">f</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;x center shift / px&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;y center shift / px&#39;</span><span class="p">);</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;</span><span class="si">% o</span><span class="s1">f shots were refined.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakTotalIntensity
  warn(f&#39;Could not read stack {sn}&#39;)
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakXPosRaw
  warn(f&#39;Could not read stack {sn}&#39;)
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakYPosRaw
  warn(f&#39;Could not read stack {sn}&#39;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
79.7 % of shots were refined.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_preprocessing_11_2.png" src="../_images/notebooks_preprocessing_11_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">scale</span> <span class="o">=</span> <span class="mi">50</span> <span class="c1"># change this to adjust contrast in the image</span>

<span class="n">idcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shifts</span><span class="p">))[(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">shifts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)]</span>
<span class="n">idcs</span> <span class="o">=</span> <span class="n">idcs</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">idcs</span><span class="p">),</span><span class="mi">4</span><span class="p">)]</span>
<span class="k">with</span> <span class="n">ds_original</span><span class="o">.</span><span class="n">Stacks</span><span class="p">()</span> <span class="k">as</span> <span class="n">stk_original</span><span class="p">,</span> <span class="n">ds_refined</span><span class="o">.</span><span class="n">Stacks</span><span class="p">()</span> <span class="k">as</span> <span class="n">stk_refined</span><span class="p">:</span>
    <span class="n">imgs</span> <span class="o">=</span> <span class="n">stk_original</span><span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">][</span><span class="n">idcs</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
    <span class="n">imgs2</span> <span class="o">=</span> <span class="n">stk_refined</span><span class="p">[</span><span class="s1">&#39;centered&#39;</span><span class="p">][</span><span class="n">idcs</span><span class="p">,</span><span class="o">...</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">img2</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imgs</span><span class="p">,</span> <span class="n">imgs2</span><span class="p">,</span> <span class="n">shifts</span><span class="p">[</span><span class="n">idcs</span><span class="p">,:],</span> <span class="n">idcs</span><span class="p">):</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">[:,</span><span class="mi">778</span><span class="p">:</span><span class="mi">778</span><span class="o">+</span><span class="mi">308</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(((</span><span class="n">img</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">2</span><span class="p">)))[:,</span><span class="mi">778</span><span class="p">:</span><span class="mi">778</span><span class="o">+</span><span class="mi">308</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(((</span><span class="n">img2</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">img2</span><span class="p">,</span><span class="mi">2</span><span class="p">)))[:,</span><span class="mi">778</span><span class="p">:</span><span class="mi">778</span><span class="o">+</span><span class="mi">308</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">scale</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shot </span><span class="si">{</span><span class="n">idx</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Initial centering&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Shifted by </span><span class="si">{</span><span class="n">shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakTotalIntensity
  warn(f&#39;Could not read stack {sn}&#39;)
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakXPosRaw
  warn(f&#39;Could not read stack {sn}&#39;)
/opts/dev/diffractem/diffractem/dataset.py:731: UserWarning: Could not read stack peakYPosRaw
  warn(f&#39;Could not read stack {sn}&#39;)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_preprocessing_12_1.png" src="../_images/notebooks_preprocessing_12_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_preprocessing_12_2.png" src="../_images/notebooks_preprocessing_12_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_preprocessing_12_3.png" src="../_images/notebooks_preprocessing_12_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_preprocessing_12_4.png" src="../_images/notebooks_preprocessing_12_4.png" />
</div>
</div>
<div class="section" id="Ready-for-indexing,-Preparation-of-sets-for-integration">
<h3>Ready for indexing, Preparation of sets for integration<a class="headerlink" href="#Ready-for-indexing,-Preparation-of-sets-for-integration" title="Permalink to this headline">¶</a></h3>
<p>Congratulations! Now you have a data set of diffraction patterns that have been summed over a certain number of fractionation frames (as defined in agg_query), that is intensity-corrected, well-centered, and ready for indexing in CrystFEL. See <code class="docutils literal notranslate"><span class="pre">indexing.ipynb</span></code>.</p>
<p><strong>However</strong>, you should not want to stop pre-processing here! There is a whole lot more to do if you want to squeeze the best out of your data - note that all of it can be done in parallel to indexing: * Apply pre-processing to <em>all</em> single movie frames, instead of only the aggregated ones. This can be done much faster now using the <code class="docutils literal notranslate"><span class="pre">pre_process.broadcast</span></code> function, which reads the found peaks and beam centers from the just finished aggregated data sets and applies (‘broadcasts’) the results
to each single movie frame. * Apply background subtraction using <code class="docutils literal notranslate"><span class="pre">pre_process.subtract_bg</span></code>, to either the aggregated frames, or all frames (see step above). It does not help for indexing (unless you include some sort of post-refinement), but the extracted intensities will be significantly more accurate, as CrystFELs BG subtraction does not work particularly well for electron data. * Once you have a set of <em>all</em> movie frames, you can make one comprising <em>cumulative</em> frames using
<code class="docutils literal notranslate"><span class="pre">pre_process.cumulate</span></code>. In such a set, each stored pattern is a cumulative sum of patterns in that movie, i.e., corresponding to a different exposure time. These are the patterns you will want to base your final peak integration on, finding out which of the exposure times gives the best final result.</p>
</div>
</div>
<div class="section" id="Apply-pre-processing-to-single-frames">
<h2>Apply pre-processing to single frames<a class="headerlink" href="#Apply-pre-processing-to-single-frames" title="Permalink to this headline">¶</a></h2>
<p>…using the knowledge gained from the aggregated ones. Important options are: select_query, single_suffix, idfields, broadcast_peaks</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">allshots</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pre_process</span><span class="o">.</span><span class="n">broadcast</span><span class="p">,</span> <span class="n">refined</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/data/shots in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
Found list /entry/map/features in Pandas/PyTables format
4040 shots out of 4197 selected.
3460 shots out of 3616 selected.
1780 shots out of 1866 selected.
5880 shots out of 6108 selected.
3670 shots out of 3833 selected.
5880 shots out of 6136 selected.
2110 shots out of 2197 selected.
4000 shots out of 4186 selected.
[21:06:51.830944 - GV_S11_008_00000_agg_refined.h5 - broadcast]  1866 raw, 1780 selected, 178 aggregated.
[21:06:51.858802 - GV_S11_003_00000_agg_refined.h5 - broadcast]  4197 raw, 4040 selected, 404 aggregated.
[21:06:51.859137 - GV_S11_004_00000_agg_refined.h5 - broadcast]  3616 raw, 3460 selected, 346 aggregated.
[21:06:51.880640 - GV_S11_001_00000_agg_refined.h5 - broadcast]  3833 raw, 3670 selected, 367 aggregated.
[21:06:51.895037 - GV_S11_009_00000_agg_refined.h5 - broadcast]  2197 raw, 2110 selected, 211 aggregated.
[21:06:51.895049 - GV_S11_002_00000_agg_refined.h5 - broadcast]  6108 raw, 5880 selected, 588 aggregated.
[21:06:51.964729 - GV_S11_005_00000_agg_refined.h5 - broadcast]  6136 raw, 5880 selected, 588 aggregated.
[21:06:51.966248 - GV_S11_007_00000_agg_refined.h5 - broadcast]  4186 raw, 4000 selected, 400 aggregated.
[21:13:41.386387 - GV_S11_008_00000_agg_refined.h5 - broadcast]  Finished with 1780 shots after 410.37758469581604 seconds
[21:15:02.907353 - GV_S11_009_00000_agg_refined.h5 - broadcast]  Finished with 2110 shots after 491.89819288253784 seconds
[21:19:50.140054 - GV_S11_004_00000_agg_refined.h5 - broadcast]  Finished with 3460 shots after 779.1321687698364 seconds
[21:20:29.380947 - GV_S11_001_00000_agg_refined.h5 - broadcast]  Finished with 3670 shots after 818.3747684955597 seconds
[21:21:37.294026 - GV_S11_007_00000_agg_refined.h5 - broadcast]  Finished with 4000 shots after 886.2849526405334 seconds
[21:21:43.474314 - GV_S11_003_00000_agg_refined.h5 - broadcast]  Finished with 4040 shots after 892.4668111801147 seconds
[21:27:42.856645 - GV_S11_005_00000_agg_refined.h5 - broadcast]  Finished with 5880 shots after 1251.848860502243 seconds
[21:27:47.888594 - GV_S11_002_00000_agg_refined.h5 - broadcast]  Finished with 5880 shots after 1256.8827607631683 seconds
</pre></div></div>
</div>
</div>
<div class="section" id="Background-subtraction">
<h2>Background subtraction<a class="headerlink" href="#Background-subtraction" title="Permalink to this headline">¶</a></h2>
<p>…applied to each single frame. Alternatively, you can also apply it to the aggregated set (created above) or the cumulative set (created below), but at this point it makes most sense (I think).</p>
<p>The way it works is: - Find Bragg peaks (if <code class="docutils literal notranslate"><span class="pre">rerun_peak_finder:</span> <span class="pre">true</span></code>), or read them from the CXI fields in the files (if <code class="docutils literal notranslate"><span class="pre">rerun_peak_finder:</span> <span class="pre">false</span></code>), and label regions around them as invalid pixels. The region radius is set by <code class="docutils literal notranslate"><span class="pre">peak_radius</span></code> in the options. - Create a radial profile by azimuthal averaging, excluding the peak regions, and apply a median filter to it with length <code class="docutils literal notranslate"><span class="pre">filter_len</span></code> (must be odd!). - Calculate a background image from the radial profile, and subtract it from the
original.</p>
<p>Unfortunately, this is still pretty slow, as the radial profile calculation is inefficient. To be optimized.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">allshots_nobg</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pre_process</span><span class="o">.</span><span class="n">subtract_bg</span><span class="p">,</span> <span class="n">allshots</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
</pre></div></div>
</div>
</div>
<div class="section" id="Cumulation">
<h2>Cumulation<a class="headerlink" href="#Cumulation" title="Permalink to this headline">¶</a></h2>
<p>Finally, datasets are created which contain ‘cumulative’ frames, that is, each frame holds the sum of all frames up to that point. An important setting is <code class="docutils literal notranslate"><span class="pre">cum_first_frame</span></code>, which allows to set the first frame from which cumulation starts, everything before is left as it is.</p>
<p>Say, you have an acquisition with 5 movie frames, then what you will get after <code class="docutils literal notranslate"><span class="pre">pre_process.cumulate</span></code> is:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 58%" />
<col style="width: 3%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>No. in stack</p></th>
<th class="head"><p>0</p></th>
<th class="head"><p>1</p></th>
<th class="head"><p>2</p></th>
<th class="head"><p>3</p></th>
<th class="head"><p>4</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>initial data</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>3</p></td>
<td><p>4</p></td>
</tr>
<tr class="row-odd"><td><p>cum_first_frame: 0</p></td>
<td><p>0</p></td>
<td><p>0+1</p></td>
<td><p>0…2</p></td>
<td><p>0…3</p></td>
<td><p>0…4</p></td>
</tr>
<tr class="row-even"><td><p>cum_first_frame: 1</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>1+2</p></td>
<td><p>1…3</p></td>
<td><p>1…4</p></td>
</tr>
<tr class="row-odd"><td><p>cum_first_frame: 2</p></td>
<td><p>0</p></td>
<td><p>1</p></td>
<td><p>2</p></td>
<td><p>2+3</p></td>
<td><p>2…4</p></td>
</tr>
</tbody>
</table>
<p>Usually, you’ll want to keep <code class="docutils literal notranslate"><span class="pre">cum_first_frame:</span> <span class="pre">0</span></code>, unless you have too much artifacts on the first frame.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">opts</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="n">cumulative</span> <span class="o">=</span> <span class="n">execute</span><span class="p">(</span><span class="n">pre_process</span><span class="o">.</span><span class="n">cumulate</span><span class="p">,</span> <span class="n">allshots_nobg</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
Single-file dataset, disabling parallel I/O.
[21:57:56.236668 - GV_S11_008_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:56.270635 - GV_S11_009_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:56.673414 - GV_S11_004_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:56.763407 - GV_S11_003_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:56.763395 - GV_S11_007_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:56.810401 - GV_S11_001_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:57.291134 - GV_S11_005_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:57.344629 - GV_S11_002_00000_all_nobg.h5 - cumulate]  Cumulating from frame 0
[21:57:59.099934 - GV_S11_008_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:57:59.154720 - GV_S11_008_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:57:59.672258 - GV_S11_009_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:57:59.726274 - GV_S11_009_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:01.399534 - GV_S11_004_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:01.460559 - GV_S11_004_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:01.747076 - GV_S11_001_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:01.841452 - GV_S11_001_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:02.279101 - GV_S11_007_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:02.342306 - GV_S11_003_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:02.348727 - GV_S11_007_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:02.412791 - GV_S11_003_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:04.260639 - GV_S11_005_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:04.331944 - GV_S11_005_00000_all_nobg.h5 - cumulate]  Writing stack data...
[21:58:04.643654 - GV_S11_002_00000_all_nobg.h5 - cumulate]  File initialized, writing tables...
[21:58:04.727328 - GV_S11_002_00000_all_nobg.h5 - cumulate]  Writing stack data...
[22:00:31.514018 - GV_S11_008_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:01:00.473555 - GV_S11_009_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:02:34.563971 - GV_S11_004_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:02:47.534345 - GV_S11_001_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:03:02.619732 - GV_S11_007_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:03:18.049877 - GV_S11_003_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:04:13.447216 - GV_S11_002_00000_all_nobg.h5 - cumulate]  Cumulation done.
[22:04:28.165381 - GV_S11_005_00000_all_nobg.h5 - cumulate]  Cumulation done.
</pre></div></div>
</div>
</div>
<div class="section" id="Done!">
<h2>Done!<a class="headerlink" href="#Done!" title="Permalink to this headline">¶</a></h2>
<p>If you’ve made it to here, you should have in your proc_data folder: - …_agg.h5: aggregated diffraction patterns (1 per feature/beam position), summed over a range of frames as defined in the <code class="docutils literal notranslate"><span class="pre">agg_query</span></code> parameter - …_agg_refined.h5: same, with refined beam center - …_all.h5: all diffraction patterns (N per feature/beam position, where N is the number of frames) - …_all_nobg.h5: same, with subtracted background - …_all_nobg_cumfrom0.h5: cumulative diffraction patterns (N per feature/beam
position, with increasing effective exposure time)</p>
<p>The structure of all files is the same, and they can be read using the diffractem.Dataset class, or CrystFEL, or anything HDF5… just open it with hdfview to get an idea.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="merging.html" class="btn btn-neutral float-right" title="Merging of serial data sets" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="indexing.html" class="btn btn-neutral float-left" title="Indexing using PinkIndexer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Robert Buecker

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>